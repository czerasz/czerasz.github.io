<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <title>Nginx Caching Tutorial - You Can Run Faster</title> <meta name="description" content="Let's dive together into the world of web content caching with Nginx. Starting with basics we will quickly move to more advanced topics and see some real wor..."> <meta content="Michal Czeraszkiewicz" name="author"> <meta content="Distributed Web Architecture, Scalable Application Development, Consulting, Trainings by czerasz.com" property="og:site_name"> <meta content="Nginx Caching Tutorial - You Can Run Faster" property="og:title"> <meta content="article" property="og:type"> <meta content="Let's dive together into the world of web content caching with Nginx. Starting with basics we will quickly move to more advanced topics and see some real world examples. If you can make it to the end of this blog post... You will bear the title of a "Caching King"." property="og:description"> <meta content="http://czerasz.com/2015/03/30/nginx-caching-tutorial/" property="og:url"> <meta content="/img/logo-high-resolution.png" property="og:image"> <meta content="2015-03-30T00:00:00+02:00" property="article:published_time"> <meta content="http://czerasz.com/about/" property="article:author"> <meta content="nginx" property="article:tag"> <meta content="caching" property="article:tag"> <meta content="performance" property="article:tag"> <meta content="web server" property="article:tag"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@czerasz"> <meta name="twitter:creator" content="@czerasz"> <meta name="twitter:title" content="Nginx Caching Tutorial - You Can Run Faster"> <meta name="twitter:url" content="http://czerasz.com/2015/03/30/nginx-caching-tutorial/"> <meta name="twitter:description" content="Let's dive together into the world of web content caching with Nginx. Starting with basics we will quickly move to more advanced topics and see some real world examples. If you can make it to the end of this blog post... You will bear the title of a "Caching King"."> <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="/assets/1441437275524/css/bootstrap.min.css" rel="stylesheet"> <link rel="stylesheet" href="/assets/1441437275524/css/main.css"> <link rel="canonical" href="http://czerasz.com/2015/03/30/nginx-caching-tutorial/"> <link rel="alternate" type="application/atom+xml" title="Web IT Services" href="http://czerasz.com/feed.xml" /> <link href='http://fonts.googleapis.com/css?family=Raleway%7CMerriweather' rel='stylesheet' type='text/css'> <link rel="shortcut icon" href="/assets/1441437275524/img/favicons/favicon.ico"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/1441437275524/img/favicons/apple-touch-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/1441437275524/img/favicons/apple-touch-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/1441437275524/img/favicons/apple-touch-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/1441437275524/img/favicons/apple-touch-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/1441437275524/img/favicons/apple-touch-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/1441437275524/img/favicons/apple-touch-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/1441437275524/img/favicons/apple-touch-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/1441437275524/img/favicons/apple-touch-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/1441437275524/img/favicons/apple-touch-icon-180x180.png"> <link rel="icon" type="image/png" href="/assets/1441437275524/img/favicons/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/assets/1441437275524/img/favicons/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/assets/1441437275524/img/favicons/favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="/assets/1441437275524/img/favicons/favicon-192x192.png" sizes="192x192"> <meta name="msapplication-TileColor" content="#30c5fb"> <meta name="msapplication-TileImage" content="/assets/1441437275524/img/favicons/mstile-144x144.png"> <meta name="msapplication-square70x70logo" content="/assets/1441437275524/img/favicons/mstile-70x70.png"/> <meta name="msapplication-square150x150logo" content="/assets/1441437275524/img/favicons/mstile-150x150.png"/> <meta name="msapplication-square310x310logo" content="/assets/1441437275524/img/favicons/mstile-310x310.png"/> <meta name="msapplication-wide310x150logo" content="/assets/1441437275524/img/favicons/mstile-310x150.png"/> <link rel="manifest" href="/assets/1441437275524/favicon/manifest.json"> <meta name="msapplication-config" content="/assets/1441437275524/favicon/browserconfig.xml"> <meta name="theme-color" content="#ffffff"> <meta name='yandex-verification' content='6c277a06e11615e8' /> </head> <body> <div id="home"></div> <header itemscope itemtype="http://schema.org/LocalBusiness"> <nav class="navbar navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a itemprop="url" class="navbar-brand" href="http://czerasz.com/"> <img src="/assets/1441437275524/img/logo.png" width="183" height="81" alt="www.czerasz.com" id="logo"> </a> <!-- <a class="navbar-brand" href="http://czerasz.com/">Web IT Services</a> --> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class=""> <a class="page-link" href="http://czerasz.com/">Home</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/about/">About</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/blog/">Blog</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/contact/">Contact</a> </li> </ul> </div><!-- /.nav-collapse --> </div><!-- /.container --> </nav> <meta itemprop="name" content="http://czerasz.com"> <meta itemprop="telephone" content="+4917667527905"> <span itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"> <meta itemprop="addressLocality" content="Berlin"> <meta itemprop="addressCountry" content="Germany"></span> <meta itemprop="email" content="contact@czerasz.com"> </header> <div class="container post" style="padding-top: 130px"> <div class="row"> <div class="col-md-9" itemscope itemtype="http://schema.org/Article" > <header class="post-header"> <h1 itemprop="name" class="post-title">Nginx Caching Tutorial - You Can Run Faster</h1> <p itemprop="dateCreated" content="2015-03-30" class="article__date"><i class="glyphicon glyphicon-time"></i> Mar 30, 2015</p> <meta itemprop="datePublished" content="2015-03-30"> </header> <article itemprop="articleBody" class="post-content"> <p class="post__tldr" itemprop="description">Let's dive together into the world of web content caching with Nginx. Starting with basics we will quickly move to more advanced topics and see some real world examples. If you can make it to the end of this blog post... You will bear the title of a "Caching King".</p> <h2 id="introduction">Introduction</h2> <p>Let me start with an inspiring story.</p> <blockquote> <p>A friend of mine took a contract for creating a simple web application. This app was used during a crowdfunding event, to visualize live statistics about the raised money for a children hospital. People donated money and the total amount with other details were displayed on a big screen. Additionally this service was available online. The application was very simple and the server strong. Luckily the generosity and love were much bigger. The server started to slow down. My friend got in panic but he found a clever and easy solution - he used Nginx’s caching capabilities.</p> </blockquote> <p>Today I will show you how to make the internet faster and more stable. How you can easily adapt Nginx’s caching, to boost your applications.</p> <p>We will start with caching concepts and then jump into available Nginx caching configuration - directives. I will explain why they are useful and how you can profit from them. Armored with the right knowledge we will fight our way through a real world example.</p> <h2 id="the-caching-concept">The Caching Concept</h2> <p>Before we start I need to make an a priori assumption. Namely that the content is quasi real time. This means that our data or if you wish our HTTP responses, do not change so often. Please note that the phrase "not so often" is not a strict definition. It can be 1 second, 1 hour, 1 week etc.</p> <p>Ok, having this in mind let’s start with our initial situation, with no caching involved, which looks like this. </p> <p><img class="post__image--spacy" itemprop="image" width="301" height="60" src="/assets/1441437275524/img/posts/nginx-caching/initial-situation-request.png" alt="Nginx Caching: initial situation application request" /></p> <p>The user does a request to the application and gets a response back.</p> <p><img class="post__image--spacy" itemprop="image" width="301" height="60" src="/assets/1441437275524/img/posts/nginx-caching/initial-situation-response.png" alt="Nginx Caching: initial situation application response" /></p> <p>Adding caching to this scenario is a simple way to improve performance, capacity and availability. It works by saving responses from servers or applications to local storage or memory.</p> <p>Let’s consider this simple situation. The client does a request to the application like in the previous example but this time he goes through the cache.</p> <p><img class="post__image--spacy" itemprop="image" width="466" height="60" src="/assets/1441437275524/img/posts/nginx-caching/caching-intro-first-request.png" alt="Nginx Caching: caching intro first request" /></p> <p>The application responses and the cache forwards this response to the client but it also saves it locally.</p> <p><img class="post__image--spacy" itemprop="image" width="466" height="200" src="/assets/1441437275524/img/posts/nginx-caching/caching-intro-first-response.png" alt="Nginx Caching: caching intro first response" /></p> <p>Next time the user does the same request the cache checks if it already has this information.</p> <p><img class="post__image--spacy" itemprop="image" width="466" height="200" src="/assets/1441437275524/img/posts/nginx-caching/caching-intro-second-request.png" alt="Nginx Caching: caching intro second request" /></p> <p>And if that’s the case, it responds immediately to the user, by serving this cached content.</p> <p><img class="post__image--spacy" itemprop="image" width="466" height="200" src="/assets/1441437275524/img/posts/nginx-caching/caching-intro-second-response.png" alt="Nginx Caching: caching intro second response" /></p> <p>Please note that the second request doesn’t involve the application at all.</p> <p>Caching adds complexity to the system but it comes with great <strong>benefits</strong>:</p> <ul> <li><strong>it improves site performance</strong> - requests doesn’t have to go through the whole rendering process</li> <li><strong>it increases capacity</strong> - by reducing load on origin servers</li> <li><strong>it also gives greater availability</strong> - by serving stale content when the origin server is down</li> </ul> <p>Before we start with Nginx, I want to mention that there are also alternatives for caching content. <a href="http://www.squid-cache.org/" target="_blank">Squid Cache</a> and <a href="https://www.varnish-cache.org/" target="_blank">Varnish Cache</a> are my favourite examples. The standard use case which I saw during my career looks like this:</p> <p><img class="post__image--spacy" itemprop="image" width="631" height="192" src="/assets/1441437275524/img/posts/nginx-caching/caching-alternatives-varnish-locally.png" alt="Nginx Caching: caching alternatives varnish locally" /></p> <p>You simply put the cache in front of the HTTP server. Either on the application server or on a specially dedicated machine:</p> <p><img class="post__image--spacy" itemprop="image" width="631" height="168" src="/assets/1441437275524/img/posts/nginx-caching/caching-alternatives-varnish-load-balancer.png" alt="Nginx Caching: caching alternatives varnish load balancer" /></p> <p>This obviously adds even more complexity to the system, but it might be a better fit to your case. Read, compare features and decide.</p> <p>In this post we will focus our attention only on Nginx.</p> <h2 id="caching-with-nginx">Caching with Nginx</h2> <p>Nginx is a HTTP server and it’s brilliant for serving static files and proxying requests. Because of its asynchronous nature it stands out with a light-weight resource utilization.</p> <p>When it comes to caching, Nginx has integrations for:</p> <ul> <li>HTTP servers</li> <li>FastCGI</li> <li>uwsgi</li> <li>SCGI</li> </ul> <p>Now that we know how caching works and what Nginx is. Let’s look at Nginx’s implementation of caching.</p> <p>An example should make it clear. First the client does a request.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-1.png" alt="Nginx Caching: " /></p> <p>A sample HTTP request is presented on the diagram below:</p> <p><img class="post__image--spacy" itemprop="image" width="373" height="202" src="/assets/1441437275524/img/posts/nginx-caching/request.png" alt="Nginx Caching: HTTP request visual example" /></p> <p>Based on some details from it Nginx generates a hash key.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-2.png" alt="Nginx Caching: how the cache key is created" /></p> <p>Now Nginx checks if this hash key already exists in memory. If not, the request goes to the application.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-3.png" alt="Nginx Caching: " /></p> <p>The application answers and its response is saved to the file system.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-4.png" alt="Nginx Caching: " /></p> <p>Additionally the hash key, generated earlier, is saved into memory. To make it easier to understand I visualise the hash key value together with the location of the saved file. But remember that Nginx stores in memory only the hash key.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-5.png" alt="Nginx Caching: " /></p> <p>Finally the user gets the response back.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-6.png" alt="Nginx Caching: " /></p> <p>When our client requests the same url a second time, Nginx again generates the hash key and checks if it exists in the memory. This time it’s there, so Nginx serves the cached file from the file system which is associated with the hash key.</p> <p><img class="post__image--spacy" itemprop="image" width="493" height="382" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-7.png" alt="Nginx Caching: " /></p> <p>Please note that the second request doesn’t involve the application at all.</p> <p>For the second request clients don’t wait for the application to first fetch data from the database and then render the page. Instead Nginx serves a static file with a cached version of the response.</p> <p>Additionally those files are most probably cached in memory. This time not by Nginx (although it gives the OS some hints) but by the operating system. It’s a Linux’s attribute to use the resources as efficient as possible. This makes reading files from the file system extremely fast.</p> <h3 id="configuration---available-directives">Configuration - Available Directives</h3> <p>Now that we know the technical background, of how Nginx’s cache works, let’s see how we can configure it.</p> <p>First on the <code>http</code> level we define where the data should be stored. We specify the path on the file system and the memory zone and their size. The <strong>memory zone</strong> stores <strong>only meta</strong> information on cached items - hash keys.</p> <blockquote> <p><strong>Note</strong> <br /> Each item takes about <code>0.125 kB</code> of memory so we can store a lot of them. In <code>1MB</code> for example Nginx can store about <code>8000</code> cache keys.</p> </blockquote> <h3 id="basics">Basics</h3> <p>The basic cache definition looks like this:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_path /data/nginx/cache <span class="nv">keys_zone</span><span class="o">=</span>zone_name_one:10m<span class="p">;</span></code></pre></div> <p>To enable it we just use the <code>proxy_cache</code> directive.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache zone_name_one<span class="p">;</span></code></pre></div> <p>This video will show you the basics of Nginx caching.</p> <iframe width="853" height="480" src="https://www.youtube.com/embed/I07MEdsSMOs?rel=0" frameborder="0" allowfullscreen=""></iframe> <p>The Github project mentioned in the video can be found <a href="https://github.com/czerasz/nginx-caching-example" target="_blank">here</a>.</p> <p>It’s also possible to limit the size of the file system used to store cached content, simply by adding the <code>max_size</code> parameter.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_path /data/nginx/cache <span class="nv">keys_zone</span><span class="o">=</span>one:10m <span class="code-highlight-red">max_size=200m</span><span class="p">;</span></code></pre></div> <p>Then we have also the option to say when files should be removed (from the cache regardless of their freshness) when they are not used for a specific amount of time.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_path /data/nginx/cache <span class="nv">keys_zone</span><span class="o">=</span>one:10m <span class="code-highlight-red">inactive=60m</span><span class="p">;</span></code></pre></div> <p>And there is also a nice little parameter which let’s us define the hierarchy levels of a cache.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_path /data/nginx/cache <span class="code-highlight-red">levels=1:2</span> <span class="nv">keys_zone</span><span class="o">=</span>one:10m<span class="p">;</span></code></pre></div> <p>The image below illustrates the hierarchy levels configuration:</p> <p><img class="post__image--spacy" itemprop="image" width="427" height="102" src="/assets/1441437275524/img/posts/nginx-caching/levels-example-1.png" alt="Nginx Caching: proxy_cache_path levels example" /></p> <p>Now let’s see if you understand it correctly. Ready for a quiz? Based on the illustration below, what should the levels parameter be?</p> <p><img class="post__image--spacy" itemprop="image" width="427" height="102" src="/assets/1441437275524/img/posts/nginx-caching/levels-example-2.png" alt="Nginx Caching: proxy_cache_path levels example" /></p> <p>The answer is <code>2:4</code>, which is more clear if we look at the following image:</p> <p><img class="post__image--spacy" itemprop="image" width="427" height="102" src="/assets/1441437275524/img/posts/nginx-caching/levels-example-3.png" alt="Nginx Caching: proxy_cache_path levels example" /></p> <h3 id="whatwhen-to-cache">What/When to cache?</h3> <p>By default Nginx caches only GET and HEAD requests. You can change this with the <code>proxy_cache_methods</code> directive:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_methods GET HEAD POST<span class="p">;</span></code></pre></div> <p>You can also instruct Nginx to cache the response only after it was requested at least 5 times. </p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_min_uses 5<span class="p">;</span></code></pre></div> <p>This would be useful in a situation where you have a lot of content, but you would only like to cache only those requests which are really popular.</p> <p>Nginx can save us upstream bandwidth and disk writes as well. By respecting cache headers and <code>304, not modified</code> responses Nginx will not download the content again if the following directive is turned on:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_revalidate on<span class="p">;</span></code></pre></div> <h3 id="how-to-cache">How to cache?</h3> <p>With Nginx we are not limited to cache everything by the same rule. Instead we can tell Nginx which information should be used to generate the hash key. And we can do it on the <code>http</code>, <code>server</code> or <code>location</code> level. Here are two examples:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_key <span class="s2">&quot;$host$request_uri$cookie_user&quot;</span><span class="p">;</span></code></pre></div> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_key <span class="s2">&quot;$scheme$proxy_host$uri$is_args$args&quot;</span><span class="p">;</span></code></pre></div> <blockquote> <p><strong>Tip</strong> <br />How to generate a Nginx cache hash key? Use this command:</p><pre><code>echo -n ‘httpczerasz.com/time.php’ | md5sum
</code></pre></blockquote> <p>We can also tell Nginx, under which conditions the request shouldn’t be stored in the cache.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_no_cache <span class="nv">$http_pragma</span> <span class="nv">$http_authorization</span> <span class="nv">$cookie_nocache</span> <span class="nv">$arg_nocache</span><span class="p">;</span></code></pre></div> <h3 id="how-long-to-cache">How long to cache?</h3> <p>There is a simple directive which tells Nginx how long to cache the responses of a certain type:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_valid any      1m<span class="p">;</span>
proxy_cache_valid <span class="m">200</span> <span class="m">302</span> 10m<span class="p">;</span></code></pre></div> <p>But mainly the headers of the origin server define the cacheability of the content:</p> <ul> <li>Expires</li> <li>Cache-Control</li> <li>X-Accel-Expires - Nginx special header. <br /><strong>Overrides other headers</strong>. Used when you need to serve different headers to the client.</li> </ul> <p>The priority of the mentioned options are presented on the chart below, with the strongest priority on top:</p> <p><img class="post__image--spacy" itemprop="image" width="440" height="600" src="/assets/1441437275524/img/posts/nginx-caching/nginx-cache-priority.png" alt="Nginx Caching: caching headers priority" /></p> <h3 id="other">Other</h3> <p>The following option adds a lot to the availability factor. It allows Nginx to serve stale (old, expired) content when the application response timed out or returned a <code>50x</code> status code:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_use_stale error timeout<span class="p">;</span></code></pre></div> <p>Yet another cool feature is the ability to let only the first request through to the application. This can be enabled with:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_lock on<span class="p">;</span></code></pre></div> <p>You already know, that the returned content by the origin is streamed to disk. By default to a location defined in the <code>proxy_cache_path</code> directive. You could also store those files in a temporary directory before they are moved to the cache path. If you need this behaviour use this:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_temp_path /tmp/custom_cache/<span class="p">;</span></code></pre></div> <p>This directive works good with multiple caches. But remember that it will be always less efficient than if the temp path is the same as the cache path</p> <h2 id="debugging-nginx39s-cache">Debugging Nginx's Cache</h2> <p>I believe that debugging any software the right way is even more important than actually knowing the software itself. A good debugging process guarantees a better understanding and most important, solving challenges really fast.</p> <p>In this chapter I will show you few tricks to easily debug Nginx’s caching wold.</p> <p>The first trick is about bypassing the cache.</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_bypass <span class="nv">$arg_nocache</span> <span class="nv">$cookie_nocache</span> <span class="nv">$arg_comment</span><span class="p">;</span></code></pre></div> <p>The directive above allows you to specify when to omit the cache. This means that each request with a <code>nocache=true</code> query parameter goes to the origin. It might even be that Nginx will cache the result as well.</p> <p>Another trick is adding a header with cache status information. You can do it simply by adding a header:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">add_header X-Cache-Status <span class="nv">$upstream_cache_status</span><span class="p">;</span></code></pre></div> <p>Or in a more sophisticated way presented below, which allows only local requests to view the header:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">map <span class="nv">$remote_addr</span> <span class="nv">$cache_status</span> <span class="o">{</span>
    127.0.0.1 <span class="nv">$upstream_cache_status</span><span class="p">;</span>
    default <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="o">}</span>
...
add_header X-Cache-Status <span class="nv">$cache_status</span><span class="p">;</span></code></pre></div> <p>By debugging the <code>X-Cache-Status</code> header you will appreciate the following table:</p> <table class="table table-striped"> <tbody> <tr> <td><strong>MISS</strong></td> <td>Object was not found in the cache. Response was served from the origin. Response may have been saved to cache.</td> </tr> <tr> <td><strong>BYPASS</strong></td> <td>Got response from upstream. Response may have been saved to cache.</td> </tr> <tr> <td><strong>EXPIRED</strong></td> <td>Cached object has expired. Response was served from the upstream.</td> </tr> <tr> <td><strong>STALE</strong></td> <td>Object served from cache because of issues with origin server response</td> </tr> <tr> <td><strong>UPDATING</strong></td> <td>Serve stale content from cache because <code>proxy_cache_lock</code> has timed out and <code>proxy_use_stale</code> takes controll</td> </tr> <tr> <td><strong>REVALIDATED</strong></td> <td><code>proxy_cache_revalidate</code> verified that the current cached content was still valid</td> </tr> <tr> <td><strong>HIT</strong></td> <td>The object was found in the cache and it is served from there</td> </tr> </tbody> </table> <p>In the following two chapters we will learn which processes are involved in the maintenance of cached files. This chapters are really short and right after we will jump into cool examples. So stay with me!</p> <h2 id="cache-loader">Cache Loader</h2> <p>The Nginx cache loader is a process responsible for loading cache from disk.</p> <p>It is run only once (on startup) and loads the metadata into the memory zone. It runs in iterations until all keys are loaded.</p> <p>We can tune it’s behaviour (to utilize CPU the right way) with the following options:</p> <ul> <li><code>loader_threshold</code> - how long is one iteration time</li> <li><code>loader_files</code> - don’t load more items than</li> <li><code>loader_sleeps</code> - pause time between iterations</li> </ul> <p>An example is presented below:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">proxy_cache_path /data/nginx/cache <span class="nv">keys_zone</span><span class="o">=</span>one:10m <span class="code-highlight-red">[loader_files=number] [loader_sleep=time] [loader_threshold=time]</span><span class="p">;</span></code></pre></div> <p>The comic below shows that the cache loader is used only on startup and that it works in iterations defined by the described parameters.</p> <p><img class="post__image--spacy" itemprop="image" width="839" height="261" src="/assets/1441437275524/img/posts/nginx-caching/nginx-loader.png" alt="Nginx Caching: how does the nginx cache loader works?" /></p> <h2 id="cache-manager">Cache Manager</h2> <p>The Nginx cache manager is a process which purges the cache over time.</p> <p>It periodically checks file storage and removes least recently used data if the file size exceeds <code>max_size</code>. It also removes files which were not used independently of the cache settings.</p> <p>Watch the comic below which illustrates cache manager duties.</p> <p><img class="post__image--spacy" itemprop="image" width="839" height="261" src="/assets/1441437275524/img/posts/nginx-caching/nginx-manager.png" alt="Nginx Caching: how does the nginx cache manager works?" /></p> <h2 id="examples">Examples</h2> <p>In this chapter I will present two real world examples. </p> <p>The first one is based on what we have learned so far. We will see how to purge content which was previously cached. </p> <p>The second example is a little bit more advanced. I shows how to build a small CDN based on Nginx.</p> <h3 id="how-to-create-a-small-cdn-with-nginx">How to create a small CDN with Nginx?</h3> <p>This example describes how Nginx can help you create a simple, file based CDN with static content.</p> <p>Let’s assume we have a distributed file system cluster. It can be based on <a href="http://en.wikipedia.org/wiki/Network_File_System" target="_blank">NFS</a> or <a href="http://www.gluster.org/" target="_blank">GlusterFS</a> or on anything you prefer. One thing those technologies have in common is that they are slow. Luckily Nginx together with the Slow FS module can overcome this weakness by caching files from a network file system on the local drive.</p> <p>For this example I prepared a project on Github which you can find <a href="https://github.com/czerasz/nginx-slowfs-example/" target="_blank">here</a>. An overview is presented on the diagram below:</p> <p><img class="post__image--spacy" itemprop="image" width="100%" src="/assets/1441437275524/img/posts/nginx-caching/nginx-slowfs.png" alt="Nginx Caching: nginx slowfs overview" /></p> <p>To get started simply clone the repository:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone git@github.com:czerasz/nginx-slowfs-example.git</code></pre></div> <p>Once you have it go to the project’s directory and start the Docker container with:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">docker-compose up</code></pre></div> <p>This might take a while because a Nginx compilation process takes place inside the container. To be able to use the slowfs feature we need to compile Nginx together with the <a href="http://labs.frickle.com/nginx_ngx_slowfs_cache/" target="_blank">Slow FS module</a>. This is done in the <code>Dockerfile</code>. If you are interested how this is done check it out <a href="https://github.com/czerasz/nginx-slowfs-example/blob/master/Dockerfile" target="_blank">here</a>.</p> <p>Then request Nginx with <code>curl</code>:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -i <span class="s1">&#39;localhost:8000/test-file.txt&#39;</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.6.2
Date: Mon, <span class="m">23</span> Mar <span class="m">2015</span> 13:35:07 GMT
Content-Type: text/plain
Content-Length: 4
Last-Modified: Mon, <span class="m">23</span> Mar <span class="m">2015</span> 12:48:15 GMT
Connection: keep-alive
Accept-Ranges: bytes

<span class="nb">test</span></code></pre></div> <p>What you see is (the content of) the file stored in the "mounted" <a href="https://github.com/czerasz/nginx-slowfs-example/tree/master/nfs-dummy" target="_blank"><code>nfs-dummy</code> directory</a>.</p> <p>If this directory would be a busy NFS mount and the number of requests would be high, then the responses would be really slow.</p> <p>But in our example the files are cached locally. You can inspect the cache directory with the following command:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>docker <span class="nb">exec </span>nginxslowfs_nginx_1 tree -A /data/cache/
/data/cache/
└── 1
    └── 27
        └── 2bba799df783554d8402137ca199a271</code></pre></div> <p>The Nginx configuration for our example is simple and consists of two parts. The cache definition:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Configure slowfs module</span>
slowfs_cache_path  /data/cache <span class="nv">levels</span><span class="o">=</span>1:2 <span class="nv">keys_zone</span><span class="o">=</span>fastcache:10m<span class="p">;</span>
slowfs_temp_path   /data/temp <span class="m">1</span> 2<span class="p">;</span></code></pre></div> <p>And the cache enabling section:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">location / <span class="o">{</span>
    root                /data/nfs<span class="p">;</span>
    slowfs_cache        fastcache<span class="p">;</span>
    slowfs_cache_key    <span class="nv">$uri</span><span class="p">;</span>
    slowfs_cache_valid  1d<span class="p">;</span>

    index  index.html index.htm<span class="p">;</span>
<span class="o">}</span></code></pre></div> <p>One nifty feature of the Slow FS module is <strong>cache purging</strong>. It can be enabled with the following configuration block:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">location ~ /purge<span class="o">(</span>/.*<span class="o">)</span> <span class="o">{</span>
    allow               127.0.0.1<span class="p">;</span>
    deny                all<span class="p">;</span>
    slowfs_cache_purge  fastcache <span class="nv">$1</span><span class="p">;</span>
<span class="o">}</span></code></pre></div> <p>This allows purging for internal requests</p> <p>Let’s test it with <code>curl</code> from inside of the docker container:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>docker <span class="nb">exec </span>nginxslowfs_nginx_1 curl -i <span class="s1">&#39;localhost:80/purge/test-file.txt&#39;</span> 
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.6.2
Date: Tue, <span class="m">24</span> Mar <span class="m">2015</span> 13:04:25 GMT
Content-Type: text/html
Content-Length: 263
Connection: keep-alive

&lt;html&gt;
&lt;head&gt;&lt;title&gt;Successful purge&lt;/title&gt;&lt;/head&gt;
&lt;body <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span>&gt;
&lt;center&gt;&lt;h1&gt;Successful purge&lt;/h1&gt;
&lt;br&gt;Key : /test-file.txt
&lt;br&gt;Path: /data/cache/1/27/2bba799df783554d8402137ca199a271
&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.6.2&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div> <p>Nginx says that it was successful but you can always double-check with the following command:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>docker <span class="nb">exec </span>nginxslowfs_nginx_1 tree -A /data/cache/                        
/data/cache/
└── 1
    └── 27</code></pre></div> <h2 id="bonus">Bonus</h2> <p>Now, because you came so far, I would like to honour your effort. I want to appoint you as the Cache King of Nginx’s land.</p> <p><img itemprop="image" width="100%" src="/assets/1441437275524/img/posts/nginx-caching/crown-foto-preview.jpg" alt="Nginx Caching: paper crown photo" /></p> <p>Please wear <a href="/assets/1441437275524/caching-king-paper-crown.pdf" target="_blank">this crone</a> with pride and swear to use cache wisely and spread its power all over the world.</p> <p><img itemprop="image" width="100%" src="/assets/1441437275524/img/posts/nginx-caching/crown-preview.png" alt="Nginx Caching: paper crown template" /></p> <h2 id="resources">Resources:</h2> <ul> <li><a href="http://nginx.com/resources/admin-guide/caching/">NGINX Content Caching</a></li> <li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">Nginx Caching Manual</a></li> <li><a href="https://kura.io/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/">More nginx proxy_cache optimizations and nginx load balancing</a></li> <li><a href="https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching">Understanding Nginx HTTP Proxying, Load Balancing, Buffering, and Caching</a></li> </ul> </article> <div class="divider divider--text"> <p class="typography-small">Share</p> </div> <div class="post__social-section clearfix"> <!-- Buttons start here. --> <ul class="rrssb-buttons"> <li class="rrssb-twitter"> <a href="http://twitter.com/share?url=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F&amp;via=czerasz&amp;text=Nginx+Caching+Tutorial+-+You+Can+Run+Faster&amp;lang=en&amp;count=none&amp;counturl=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F&amp;hashtags=nginx%2Ccaching%2Cperformance%2Cweb server%2C" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via twitter" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-twitter"></use> </svg> </span> <span class="rrssb-text">twitter</span> </a> </li> <li class="rrssb-googleplus"> <a href="https://plus.google.com/share?url=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F&amp;hl=en-US" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via google plus" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-google-plus"></use> </svg> </span> <span class="rrssb-text">google+</span> </a> </li> <li class="rrssb-linkedin"> <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F&amp;title=Nginx+Caching+Tutorial+-+You+Can+Run+Faster&amp;source=czerasz.com+%7C+Web+IT+Services&amp;summary=Let%27s+dive+together+into+the+world+of+web+content+caching+with+Nginx.+Starting+with+basics+we+will+quickly+move+to+more+advanced+topics+and+see+some+real+world+examples.+If+you+can+make+it+to+the+end+of+this+blog+post...+You+will+bear+the+title+of+a+%22Caching+King%22." target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via linkedin" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-linkedin"></use> </svg> </span> <span class="rrssb-text">linkedin</span> </a> </li> <li class="rrssb-facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via facebook" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-facebook"></use> </svg> </span> <span class="rrssb-text">facebook</span> </a> </li> <li class="rrssb-delicious"> <a href="https://delicious.com/save?v=5&amp;provider=czerasz.com&amp;noui&amp;jump=close&amp;url=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F&amp;title=Nginx+Caching+Tutorial+-+You+Can+Run+Faster" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="save to delicious" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-delicious"></use> </svg> </span> <span class="rrssb-text">Delicious</span> </a> </li> <li class="rrssb-email"> <a href="mailto:?subject=Epic+article+about%3A+Nginx+Caching+Tutorial+-+You+Can+Run+Faster&amp;body=Check+out+this+link%3A+http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F+published+by+Micha%C5%82+Czeraszkiewicz" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via email" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-email"></use> </svg> </span> <span class="rrssb-text">email</span> </a> </li> <li class="rrssb-pocket"> <a href="https://getpocket.com/save?url=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 32 28" class="svg-icon" role="img" aria-label="save to pocket" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-pocket"></use> </svg> </span> <span class="rrssb-text">pocket</span> </a> </li> <li class="rrssb-reddit"> <a href="http://www.reddit.com/submit?url=http%3A%2F%2Fczerasz.com%2F2015%2F03%2F30%2Fnginx-caching-tutorial%2F" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via reddit" style='fill: #fff;'> <use xlink:href="/assets/1441437275524/img/svg/social-section.svg#icon-reddit"></use> </svg> </span> <span class="rrssb-text">reddit</span> </a> </li> </ul> <!-- Buttons end here --> </div> <div class="article__author-container" itemprop="author"> <div class="divider divider--text"> <p class="typography-small">Author</p> </div> <img class="article__avatar" src="http://www.gravatar.com/avatar/88954c51cd72a270af461de17fa2e150.png" alt="czerasz avatar" height="80" width="80"> <div class="article__author-info" itemscope itemtype="http://schema.org/Person"> <h4 itemprop="name">Michał Czeraszkiewicz</h4> <p><span itemprop="jobTitle">Full Stack Developer, Consultant</span>. Web technology enthusiast with pashion for web architecture. You can follow him on <a href="https://twitter.com/czerasz" target="_blank">Twitter</a> or <a href="https://plus.google.com/u/0/117800598211330706058?rel=author" target="_blank">Google+</a>.</p> </div> <!-- gem-author-info --> </div> <div class="divider clearfix"></div> <div class="post__navigation-bottom"> <a class="btn btn-default" href="/blog"> <span class="glyphicon glyphicon-chevron-left"></span> back </a> <a class="btn btn-primary" href="#home"> <span class="glyphicon glyphicon-chevron-up"></span> go up </a> </div> <div class="divider clearfix"></div> <section class="callout callout--center"> <h3>Like what You see?</h3> <a class="btn btn-lg btn-primary" href="/contact">Then let us work together!</a> <p>We provide high quality web IT services. From solid front-end architecture, through scalable back-end applications, up to distrubuted data stores. Every piece of your infrastructure is build with passion.</p> </section> </div> </div> </div> <footer class="site-footer"> <div class="site-footer__footer-above"> <div class="container"> <div class="row"> <div class="col-md-4 col-md-offset-4"> <h3>Social</h3> <div class="footer__social-icons"> <a href="https://twitter.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's twitter page"> <use xlink:href="/assets/1441437275524/img/svg/social.svg#icon-twitter"></use> </svg> </a> <a href="https://github.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's github profile page"> <use xlink:href="/assets/1441437275524/img/svg/social.svg#icon-github"></use> </svg> </a> <a href="http://stackoverflow.com/users/325852/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's stackoverflow profile page"> <use xlink:href="/assets/1441437275524/img/svg/social.svg#icon-stackoverflow"></use> </svg> </a> <a href="https://www.linkedin.com/in/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's linkedin profile page"> <use xlink:href="/assets/1441437275524/img/svg/social.svg#icon-linkedin"></use> </svg> </a> <a href="https://delicious.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's delicious profile page"> <use xlink:href="/assets/1441437275524/img/svg/social.svg#icon-delicious"></use> </svg> </a> <a href="https://plus.google.com/u/0/117800598211330706058?rel=author"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's google plus profile page"> <use xlink:href="/assets/1441437275524/img/svg/social.svg#icon-google-plus"></use> </svg> </a> </div> <div class="divider divider--border visible-xs-block visible-sm-block"></div> </div> <div class="col-md-4"> <h3>About</h3> <p>Solid knowledge about web and web-technologies. Focused on Back-End, Front-End and DevOps topics. Docker, Python, Nginx, Linux, IT-Architecture, Vagrant, Ansible, MongoDB and Elasticsearch. </p> <a class="btn btn-default pull-right" style="margin-top: 20px" href="/about/">read more</a> </div> </div> </div> </div> <div class="site-footer__footer-below"> <div class="container"> <div class="row"> <div class="col-md-12"> <p class="text-center">© 2015 &middot; czerasz &middot; All Rights Reserved | Made with &hearts; in Berlin</p> </div> </div> </div> </div> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> <script src="/assets/1441437275524/js/bootstrap.min.js"></script> <script src="/assets/1441437275524/vendor/RRSSB/js/rrssb.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18008380-5', 'auto'); ga('send', 'pageview'); </script> </body> </html>
