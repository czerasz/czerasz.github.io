<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <title>WRK the HTTP benchmarking tool - Advanced Example</title> <meta name="description" content="wrk is the HTTP benchmarking tool which combined with Lua scripts can be the bazooka in your benchmarking arsenal. This article shows an advanced example of ..."> <meta content="Michal Czeraszkiewicz" name="author"> <meta content="Distributed Web Architecture, Scalable Application Development, Consulting, Trainings by czerasz.com" property="og:site_name"> <meta content="WRK the HTTP benchmarking tool - Advanced Example" property="og:title"> <meta content="article" property="og:type"> <meta content="wrk is the HTTP benchmarking tool which combined with Lua scripts can be the bazooka in your benchmarking arsenal. This article shows an advanced example of using Lua scripts with wrk. I will also show you how to debug wrk." property="og:description"> <meta content="http://czerasz.com/2015/07/19/wrk-http-benchmarking-tool-example/" property="og:url"> <meta content="/img/logo-high-resolution.png" property="og:image"> <meta content="2015-07-19T00:00:00+02:00" property="article:published_time"> <meta content="http://czerasz.com/about/" property="article:author"> <meta content="wrk" property="article:tag"> <meta content="lua" property="article:tag"> <meta content="benchmarking" property="article:tag"> <meta content="http" property="article:tag"> <meta content="http benchmarking" property="article:tag"> <meta content="json" property="article:tag"> <meta content="debugging wrk" property="article:tag"> <meta content="wrk documentation" property="article:tag"> <meta content="lua script" property="article:tag"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@czerasz"> <meta name="twitter:creator" content="@czerasz"> <meta name="twitter:title" content="WRK the HTTP benchmarking tool - Advanced Example"> <meta name="twitter:url" content="http://czerasz.com/2015/07/19/wrk-http-benchmarking-tool-example/"> <meta name="twitter:description" content="wrk is the HTTP benchmarking tool which combined with Lua scripts can be the bazooka in your benchmarking arsenal. This article shows an advanced example of using Lua scripts with wrk. I will also show you how to debug wrk."> <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="/assets/1437519807441/css/bootstrap.min.css" rel="stylesheet"> <link rel="stylesheet" href="/assets/1437519807441/css/main.css"> <link rel="canonical" href="http://czerasz.com/2015/07/19/wrk-http-benchmarking-tool-example/"> <link rel="alternate" type="application/atom+xml" title="Web IT Services" href="http://czerasz.com/feed.xml" /> <link href='http://fonts.googleapis.com/css?family=Raleway%7CMerriweather' rel='stylesheet' type='text/css'> <link rel="shortcut icon" href="/assets/1437519807441/img/favicons/favicon.ico"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/1437519807441/img/favicons/apple-touch-icon-57x57.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/1437519807441/img/favicons/apple-touch-icon-114x114.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/1437519807441/img/favicons/apple-touch-icon-72x72.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/1437519807441/img/favicons/apple-touch-icon-144x144.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/1437519807441/img/favicons/apple-touch-icon-60x60.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/1437519807441/img/favicons/apple-touch-icon-120x120.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/1437519807441/img/favicons/apple-touch-icon-76x76.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/1437519807441/img/favicons/apple-touch-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/1437519807441/img/favicons/apple-touch-icon-180x180.png"> <link rel="icon" type="image/png" href="/assets/1437519807441/img/favicons/favicon-192x192.png" sizes="192x192"> <link rel="icon" type="image/png" href="/assets/1437519807441/img/favicons/favicon-160x160.png" sizes="160x160"> <link rel="icon" type="image/png" href="/assets/1437519807441/img/favicons/favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="/assets/1437519807441/img/favicons/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/assets/1437519807441/img/favicons/favicon-32x32.png" sizes="32x32"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/1437519807441/img/favicons/mstile-144x144.png"> <meta name="msapplication-square70x70logo" content="/assets/1437519807441/img/favicons/mstile-70x70.png"/> <meta name="msapplication-square150x150logo" content="/assets/1437519807441/img/favicons/mstile-150x150.png"/> <meta name="msapplication-square310x310logo" content="/assets/1437519807441/img/favicons/mstile-310x310.png"/> <meta name="msapplication-wide310x150logo" content="/assets/1437519807441/img/favicons/mstile-310x150.png"/> <meta name='yandex-verification' content='6c277a06e11615e8' /> </head> <body> <div id="home"></div> <header itemscope itemtype="http://schema.org/LocalBusiness"> <nav class="navbar navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a itemprop="url" class="navbar-brand" href="http://czerasz.com/"> www.czerasz.com </a> <!-- <a class="navbar-brand" href="http://czerasz.com/">Web IT Services</a> --> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class=""> <a class="page-link" href="http://czerasz.com/">Home</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/about/">About</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/blog/">Blog</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/contact/">Contact</a> </li> </ul> </div><!-- /.nav-collapse --> </div><!-- /.container --> </nav> <meta itemprop="name" content="http://czerasz.com"> <meta itemprop="telephone" content="+4917667527905"> <span itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"> <meta itemprop="addressLocality" content="Berlin"> <meta itemprop="addressCountry" content="Germany"></span> <meta itemprop="email" content="contact@czerasz.com"> </header> <div class="container post" style="padding-top: 130px"> <div class="row"> <div class="col-md-9" itemscope itemtype="http://schema.org/Article" > <header class="post-header"> <h1 itemprop="name" class="post-title">WRK the HTTP benchmarking tool - Advanced Example</h1> <p itemprop="dateCreated" content="2015-07-19" class="article__date"><i class="glyphicon glyphicon-time"></i> Jul 19, 2015</p> <meta itemprop="datePublished" content="2015-07-19"> </header> <article itemprop="articleBody" class="post-content"> <p class="post__tldr" itemprop="description">wrk is the HTTP benchmarking tool which combined with Lua scripts can be the bazooka in your benchmarking arsenal. This article shows an advanced example of using Lua scripts with wrk. I will also show you how to debug wrk.</p> <h2 id="introduction">Introduction</h2> <p>Recently I published an <a href="https://www.digitalocean.com/community/tutorials/how-to-benchmark-http-latency-with-wrk-on-ubuntu-14-04">article on Digital Ocean</a> which is an introduction to a great HTTP benchmarking tool called <a href="https://github.com/wg/wrk">wrk</a>. It describes the basic concepts and shows usage examples. I recommend you read it before continuing with this post.</p> <p>And after you are back we will focus on a more advanced example.</p> <h2 id="requirements">Requirements</h2> <p>For some time now I use Docker instead of virtual machines when possible.</p> <p>I would like to share the Docker awesomeness with you, so please make sure you have the following tools installed:</p> <ul> <li><a href="https://docs.docker.com/installation/">Docker</a></li> <li><a href="http://docs.docker.com/compose/install/">Docker Compose</a></li> </ul> <h2 id="json-file-example">JSON File Example</h2> <p>The idea is very simple. We have an JSON file with request details and wrk will use this information in its benchmark. wrk doesn’t have this feature build in but we will use a Lua script to tell it what to do.</p> <p>The JSON file might look like this:</p> <div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path-1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;some content&quot;</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;X-Custom-Header-1&quot;</span><span class="p">:</span> <span class="s2">&quot;test 1&quot;</span><span class="p">,</span>
      <span class="nt">&quot;X-Custom-Header-2&quot;</span><span class="p">:</span> <span class="s2">&quot;test 2&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path-2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;some content&quot;</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;X-Custom-Header-1&quot;</span><span class="p">:</span> <span class="s2">&quot;test 3&quot;</span><span class="p">,</span>
      <span class="nt">&quot;X-Custom-Header-2&quot;</span><span class="p">:</span> <span class="s2">&quot;test 4&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span></code></pre></div> <p>As you can see each request has different properties.</p> <p>Save it in the <code>data</code> directory as <code>data/requests.json</code>.</p> <p>Now we need a proper lua script.</p> <p>I prepared one below, save it as <code>scripts/multi-request-json.lua</code>:</p> <div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="c1">-- Module instantiation</span>
<span class="kd">local</span> <span class="n">cjson</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">cjson&quot;</span>
<span class="kd">local</span> <span class="n">cjson2</span> <span class="o">=</span> <span class="n">cjson</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="kd">local</span> <span class="n">cjson_safe</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">cjson.safe&quot;</span>

<span class="c1">-- Initialize the pseudo random number generator</span>
<span class="c1">-- Resource: http://lua-users.org/wiki/MathLibraryTutorial</span>
<span class="nb">math.randomseed</span><span class="p">(</span><span class="nb">os.time</span><span class="p">())</span>
<span class="nb">math.random</span><span class="p">();</span> <span class="nb">math.random</span><span class="p">();</span> <span class="nb">math.random</span><span class="p">()</span>

<span class="c1">-- Shuffle array</span>
<span class="c1">-- Returns a randomly shuffled array</span>
<span class="k">function</span> <span class="nf">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
  <span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="o">#</span><span class="n">paths</span>

  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="k">do</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="nb">math.random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">paths</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="n">paths</span>
<span class="k">end</span>

<span class="c1">-- Load URL paths from the file</span>
<span class="k">function</span> <span class="nf">load_request_objects_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">content</span>

  <span class="c1">-- Check if the file exists</span>
  <span class="c1">-- Resource: http://stackoverflow.com/a/4991602/325852</span>
  <span class="kd">local</span> <span class="n">f</span><span class="o">=</span><span class="nb">io.open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">r&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">f</span><span class="o">~=</span><span class="kc">nil</span> <span class="k">then</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">*all&quot;</span><span class="p">)</span>

    <span class="nb">io.close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="c1">-- Return the empty array</span>
    <span class="k">return</span> <span class="n">lines</span>
  <span class="k">end</span>

  <span class="c1">-- Translate Lua value to/from JSON</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">cjson</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


  <span class="k">return</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- Load URL requests from file</span>
<span class="n">requests</span> <span class="o">=</span> <span class="n">load_request_objects_from_file</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/data/requests.json&quot;</span><span class="p">)</span>

<span class="c1">-- Check if at least one path was found in the file</span>
<span class="k">if</span> <span class="o">#</span><span class="n">requests</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">then</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">multiplerequests: No requests found.&quot;</span><span class="p">)</span>
  <span class="nb">os.exit</span><span class="p">()</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">multiplerequests: Found &quot;</span> <span class="o">..</span> <span class="o">#</span><span class="n">requests</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> requests&quot;</span><span class="p">)</span>

<span class="c1">-- Initialize the requests array iterator</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">request</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
  <span class="c1">-- Get the next requests array element</span>
  <span class="kd">local</span> <span class="n">request_object</span> <span class="o">=</span> <span class="n">requests</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>

  <span class="c1">-- Increment the counter</span>
  <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="c1">-- If the counter is longer than the requests array length then reset it</span>
  <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="o">#</span><span class="n">requests</span> <span class="k">then</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="c1">-- Return the request object with the current URL path</span>
  <span class="k">return</span> <span class="n">wrk</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">request_object</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="n">request_object</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">request_object</span><span class="p">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">request_object</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="k">end</span></code></pre></div> <p>This script is similar to the example presented in the <a href="https://www.digitalocean.com/community/tutorials/how-to-benchmark-http-latency-with-wrk-on-ubuntu-14-04#">Digital Ocean artilce</a>. It is extended with an shuffle functionality and instead of loading URL paths line by line we laod a JSON file. Parsing JSON requires a JSON library, which is loaded at the very top. This library transforms the request details from a JSON string into an Lua array.</p> <p>The only thing that stops us from testing this example is the missing JSON library itself - we need to install it. To save time for the installation and setup, I prepared a Docker image, which is <a href="https://registry.hub.docker.com/u/czerasz/wrk-json/">available here</a>. If you are interested in how the library is installed simply take a look at the <a href="https://github.com/czerasz/docker-wrk-json/blob/master/Dockerfile"><code>Dockerfile</code></a> - it’s well documented.</p> <p>Let’s summarise: you need to save the JSON file as <code>data/requests.json</code> and the Lua script as <code>scripts/multi-request-json.lua</code>.</p> <p>We will run wrk in a Docker container. This diagram will give you a good overview of how this is done:</p> <p><img itemprop="image" width="100%" src="/assets/1437519807441/img/posts/wrk/container-overview-json-example.png" alt="container overview for the wrk JSON example" title="container overview for the wrk JSON example" /></p> <p>Run the benchmark with:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">docker run --rm <span class="se">\</span>
           -v <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/scripts:/scripts <span class="se">\</span>
           -v <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/data:/data <span class="se">\</span>
           czerasz/wrk-json wrk -c1 -t1 -d5s -s /scripts/multi-request-json.lua http://<span class="nv">$APPLICATION_IP</span>:<span class="nv">$APPLICATION_PORT</span></code></pre></div> <p>This command will pull the <a href="https://registry.hub.docker.com/u/czerasz/wrk-json/"><code>czerasz/wrk-json</code></a> image from the public Docker registry. Then it executes the wrk command (inside the Docker container) which additionally takes the Lua script. The Lua script opens the <code>/data/requests.json</code> file, parses it and feeds wrk with the data. Everything is possible because we shared the appropriate direcotries with the Docker container by using the <code>-v</code> option.</p> <p>The returned output might look like this:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">multiplerequests: Found <span class="m">2</span> requests
multiplerequests: Found <span class="m">2</span> requests
Running 5s <span class="nb">test</span> @ http://10.135.232.163:3000
  <span class="m">1</span> threads and <span class="m">1</span> connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.32ms    1.41ms  18.91ms   91.81%
    Req/Sec     0.89k   304.69     1.47k    64.00%
  <span class="m">4447</span> requests in 5.00s, 0.85MB <span class="nb">read</span>
Requests/sec:    888.67
Transfer/sec:    174.44KB</code></pre></div> <p>Adding weights to this example could be also very easy: just duplicate the request objects or adjust the Lua script to recognize a <code>weight</code> property.</p> <p>I hope that you understand now that “sky is the limit” with wrk and Lua.</p> <h2 id="debugging-wrk">Debugging WRK</h2> <p>The ability to debug a technology properly is worth more than knowing the technology itself.</p> <p>To debug wrk I use a special Node.js application and a custom Lua script. The whole environment (based on Docker) is <a href="https://github.com/czerasz/wrk-debugging-environment">available on Github</a>.</p> <p>If you want to use it, then we need to install the required software. We just need:</p> <ul> <li><code>git</code> - to download the project</li> <li><code>docker-compose</code> - to start the Docker container environment</li> </ul> <p>I will help you setup them on Ubuntu.</p> <p>Install <code>git</code> simply by using Ubuntu’s package manager:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">apt-get install -y git</code></pre></div> <p>Docker Compose can be installed with this commands:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo curl -L https://github.com/docker/compose/releases/download/1.3.1/docker-compose-<span class="sb">`</span>uname -s<span class="sb">`</span>-<span class="sb">`</span>uname -m<span class="sb">`</span> &gt; /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose</code></pre></div> <p>If you have any trouble or want to install <code>docker-compose</code> on another system please refer to this <a href="https://docs.docker.com/compose/install/">Docker Compose installation guide</a>.</p> <p>Now clone the project:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/czerasz/wrk-debugging-environment.git</code></pre></div> <p>Enter it:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>wrk-debugging-environment</code></pre></div> <p>And spin up the required containers with:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">docker-compose run --rm wrk bash</code></pre></div> <p>The command above will create two containers - one for the <strong>application</strong> and one for <strong>wrk</strong>.</p> <p>An overview is presented below:</p> <p><img itemprop="image" width="100%" src="/assets/1437519807441/img/posts/wrk/debugging-container-overview.png" alt="container overview for the wrk debugging scenario" title="container overview for the wrk debugging scenario" /></p> <p>The command will also automatically log you in to the <strong>wrk</strong> container.</p> <p>Now whenever you execute this command inside the <strong>wrk</strong> Docker container:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">wrk -c3 -d1s -t2 -s /scripts/debug.lua http://app:3000 -- debug <span class="nb">true</span></code></pre></div> <p>You will see what happens inside wrk because <a href="https://github.com/czerasz/wrk-debugging-environment/blob/master/environments/wrk/scripts/debug.lua">the debugging scipt</a> has a lot of debugging messages (integrated simply with <code>io.write</code>).</p> <p>Sample output is presented below:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">...
------------------------------
Response <span class="m">114</span> with status: <span class="m">200</span> on thread 1
------------------------------
<span class="o">[</span>response<span class="o">]</span> Headers:
<span class="o">[</span>response<span class="o">]</span>  - Content-Length: 2
<span class="o">[</span>response<span class="o">]</span>  - ETag: W/<span class="s2">&quot;2-REvLOj/Pg4kpbElGfyfh1g&quot;</span>
<span class="o">[</span>response<span class="o">]</span>  - Connection: keep-alive
<span class="o">[</span>response<span class="o">]</span>  - Date: Tue, <span class="m">23</span> Jun <span class="m">2015</span> 20:18:01 GMT
<span class="o">[</span>response<span class="o">]</span>  - Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
<span class="o">[</span>response<span class="o">]</span>  - X-Debug: <span class="nb">true</span>
<span class="o">[</span>response<span class="o">]</span>  - X-Powered-By: Express
<span class="o">[</span>response<span class="o">]</span> Body:
ok

  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.42ms    4.23ms  36.86ms   93.15%
    Req/Sec   305.55    162.64   590.00     70.00%
  <span class="m">611</span> requests in 1.00s, 128.29KB <span class="nb">read</span>
Requests/sec:    608.23
Transfer/sec:    127.70KB
------------------------------
Requests
------------------------------
userdata<span class="o">{</span>
  <span class="o">[</span><span class="s2">&quot;bytes&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;49020&quot;</span>,
  <span class="o">[</span><span class="s2">&quot;errors&quot;</span><span class="o">]</span> <span class="o">=</span>   <span class="o">{</span>
    <span class="o">[</span><span class="s2">&quot;write&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>,
    <span class="o">[</span><span class="s2">&quot;read&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>,
    <span class="o">[</span><span class="s2">&quot;status&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>,
    <span class="o">[</span><span class="s2">&quot;timeout&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>,
    <span class="o">[</span><span class="s2">&quot;connect&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
  <span class="o">}</span>,
  <span class="o">[</span><span class="s2">&quot;duration&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;1009245&quot;</span>,
  <span class="o">[</span><span class="s2">&quot;requests&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;228&quot;</span>
<span class="o">}</span></code></pre></div> <p>Additionally the application container will log all request details. Simply open another terminal, enter the <code>wrk-debugging-environment</code> directory:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>wrk-debugging-environment</code></pre></div> <p>Then execute this command:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">docker logs -f --tail<span class="o">=</span><span class="m">0</span> <span class="k">$(</span>docker-compose ps <span class="p">|</span> grep <span class="s1">&#39;_application_1&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span></code></pre></div> <p>Whenever you execute the previous benchmak command (in the previous terminal) you should see output simmilar to this:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">...

--- --- --- --- --- --- --- --- --- --- --- --- ---

<span class="o">[</span>2015-06-23 20:28:30<span class="o">]</span> Request 486

GET/1.1 / on :::3000

Headers:
 - host: app:3000

No cookies

Body:</code></pre></div> <p>Now just edit the <a href="https://github.com/czerasz/wrk-debugging-environment/blob/master/environments/wrk/scripts/debug.lua"><code>environments/wrk/scripts/debug.lua</code></a> file and see the output changing. Play around and have fun.</p> <h2 id="summary">Summary</h2> <p>I hope that this article and <a href="https://www.digitalocean.com/community/tutorials/how-to-benchmark-http-latency-with-wrk-on-ubuntu-14-04">the one on Digital Ocean</a> gave you a better understanding about wrk and explained how to precisely shoot with heavy benchmarking bullets.</p> <h2 id="resources">Resources</h2> <ul> <li><a href="http://charmyin.github.io/informationtechnology/2014/08/11/multiple-file-upload-express/">WRK - A HTTP benchmarking tool</a> - very good article about <code>wrk</code></li> <li><a href="http://revision3.com/haktip/understanding-high-latency/">Wireshark 101: Understanding High Latency</a></li> <li><a href="https://nirajrules.wordpress.com/2009/09/17/measuring-performance-response-vs-latency-vs-throughput-vs-load-vs-scalability-vs-stress-vs-robustness/">Performance Testing - Response vs. Latency vs. Throughput vs. Load vs. Scalability vs. Stress vs. Robustness</a></li> <li><a href="https://www.youtube.com/watch?v=6Rs0p3mPNr0">How NOT to measure latency - Gil Tene at USI</a></li> <li><a href="http://danielmendel.github.io/blog/2013/04/07/benchmarkers-beware-the-ephemeral-port-limit/">Benchmarkers, Beware the Ephemeral Port Limit</a></li> <li><a href="http://kellabyte.com/2014/02/12/create-benchmarks-and-results-that-have-value/">Create benchmarks and results that have value</a></li> <li><a href="http://www.infoq.com/presentations/latency-pitfalls">How NOT to Measure Latency</a> - must watch presentation</li> <li><a href="https://github.com/giltene/jHiccup">jHiccup Project</a></li> <li><a href="https://github.com/HdrHistogram/HdrHistogram">HdrHistogram Project</a></li> </ul> </article> <div class="divider divider--text"> <p class="typography-small">Share</p> </div> <div class="post__social-section clearfix"> <!-- Buttons start here. --> <ul class="rrssb-buttons"> <li class="rrssb-twitter"> <a href="http://twitter.com/share?url=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F&amp;via=czerasz&amp;text=WRK+the+HTTP+benchmarking+tool+-+Advanced+Example&amp;lang=en&amp;count=none&amp;counturl=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F&amp;hashtags=wrk%2Clua%2Cbenchmarking%2Chttp%2Chttp benchmarking%2Cjson%2Cdebugging wrk%2Cwrk documentation%2Clua script%2C" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via twitter" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-twitter"></use> </svg> </span> <span class="rrssb-text">twitter</span> </a> </li> <li class="rrssb-googleplus"> <a href="https://plus.google.com/share?url=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F&amp;hl=en-US" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via google plus" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-google-plus"></use> </svg> </span> <span class="rrssb-text">google+</span> </a> </li> <li class="rrssb-linkedin"> <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F&amp;title=WRK+the+HTTP+benchmarking+tool+-+Advanced+Example&amp;source=czerasz.com+%7C+Web+IT+Services&amp;summary=wrk+is+the+HTTP+benchmarking+tool+which+combined+with+Lua+scripts+can+be+the+bazooka+in+your+benchmarking+arsenal.+This+article+shows+an+advanced+example+of+using+Lua+scripts+with+wrk.+I+will+also+show+you+how+to+debug+wrk." target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via linkedin" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-linkedin"></use> </svg> </span> <span class="rrssb-text">linkedin</span> </a> </li> <li class="rrssb-facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via facebook" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-facebook"></use> </svg> </span> <span class="rrssb-text">facebook</span> </a> </li> <li class="rrssb-delicious"> <a href="https://delicious.com/save?v=5&amp;provider=czerasz.com&amp;noui&amp;jump=close&amp;url=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F&amp;title=WRK+the+HTTP+benchmarking+tool+-+Advanced+Example" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="save to delicious" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-delicious"></use> </svg> </span> <span class="rrssb-text">Delicious</span> </a> </li> <li class="rrssb-email"> <a href="mailto:?subject=Epic+article+about%3A+WRK+the+HTTP+benchmarking+tool+-+Advanced+Example&amp;body=Check+out+this+link%3A+http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F+published+by+Micha%C5%82+Czeraszkiewicz" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via email" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-email"></use> </svg> </span> <span class="rrssb-text">email</span> </a> </li> <li class="rrssb-pocket"> <a href="https://getpocket.com/save?url=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 32 28" class="svg-icon" role="img" aria-label="save to pocket" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-pocket"></use> </svg> </span> <span class="rrssb-text">pocket</span> </a> </li> <li class="rrssb-reddit"> <a href="http://www.reddit.com/submit?url=http%3A%2F%2Fczerasz.com%2F2015%2F07%2F19%2Fwrk-http-benchmarking-tool-example%2F" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via reddit" style='fill: #fff;'> <use xlink:href="/assets/1437519807441/img/svg/social-section.svg#icon-reddit"></use> </svg> </span> <span class="rrssb-text">reddit</span> </a> </li> </ul> <!-- Buttons end here --> </div> <div class="article__author-container" itemprop="author"> <div class="divider divider--text"> <p class="typography-small">Author</p> </div> <img class="article__avatar" src="http://www.gravatar.com/avatar/88954c51cd72a270af461de17fa2e150.png" alt="czerasz avatar" height="80" width="80"> <div class="article__author-info" itemscope itemtype="http://schema.org/Person"> <h4 itemprop="name">Michał Czeraszkiewicz</h4> <p><span itemprop="jobTitle">Full Stack Developer, Consultant</span>. Web technology enthusiast with pashion for web architecture. You can follow him on <a href="https://twitter.com/czerasz" target="_blank">Twitter</a> or <a href="https://plus.google.com/u/0/117800598211330706058?rel=author" target="_blank">Google+</a>.</p> </div> <!-- gem-author-info --> </div> <div class="divider clearfix"></div> <div class="post__navigation-bottom"> <a class="btn btn-default" href="/blog"> <span class="glyphicon glyphicon-chevron-left"></span> back </a> <a class="btn btn-primary" href="#home"> <span class="glyphicon glyphicon-chevron-up"></span> go up </a> </div> <div class="divider clearfix"></div> <section class="callout callout--center"> <h3>Like what You see?</h3> <a class="btn btn-lg btn-primary" href="/contact">Then let us work together!</a> <p>We provide high quality web IT services. From solid front-end architecture, through scalable back-end applications, up to distrubuted data stores. Every piece of your infrastructure is build with passion.</p> </section> </div> </div> </div> <footer class="site-footer"> <div class="site-footer__footer-above"> <div class="container"> <div class="row"> <div class="col-md-4 col-md-offset-4"> <h3>Social</h3> <div class="footer__social-icons"> <a href="https://twitter.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's twitter page"> <use xlink:href="/assets/1437519807441/img/svg/social.svg#icon-twitter"></use> </svg> </a> <a href="https://github.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's github profile page"> <use xlink:href="/assets/1437519807441/img/svg/social.svg#icon-github"></use> </svg> </a> <a href="http://stackoverflow.com/users/325852/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's stackoverflow profile page"> <use xlink:href="/assets/1437519807441/img/svg/social.svg#icon-stackoverflow"></use> </svg> </a> <a href="https://www.linkedin.com/in/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's linkedin profile page"> <use xlink:href="/assets/1437519807441/img/svg/social.svg#icon-linkedin"></use> </svg> </a> <a href="https://delicious.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's delicious profile page"> <use xlink:href="/assets/1437519807441/img/svg/social.svg#icon-delicious"></use> </svg> </a> <a href="https://plus.google.com/u/0/117800598211330706058?rel=author"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's google plus profile page"> <use xlink:href="/assets/1437519807441/img/svg/social.svg#icon-google-plus"></use> </svg> </a> </div> <div class="divider divider--border visible-xs-block visible-sm-block"></div> </div> <div class="col-md-4"> <h3>About</h3> <p>Solid knowledge about web and web-technologies. Focused on Back-End, Front-End and DevOps topics. Docker, Python, Nginx, Linux, IT-Architecture, Vagrant, Ansible, MongoDB and Elasticsearch. </p> <a class="btn btn-default pull-right" style="margin-top: 20px" href="/about/">read more</a> </div> </div> </div> </div> <div class="site-footer__footer-below"> <div class="container"> <div class="row"> <div class="col-md-12"> <p class="text-center">© 2015 &middot; czerasz &middot; All Rights Reserved | Made with &hearts; in Berlin</p> </div> </div> </div> </div> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> <script src="/assets/1437519807441/js/bootstrap.min.js"></script> <script src="/assets/1437519807441/vendor/RRSSB/js/rrssb.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18008380-5', 'auto'); ga('send', 'pageview'); </script> </body> </html>
