<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <title>Nginx Maintenance Mode with Integration Testing</title> <meta name="description" content="This article shows how to enable a maintenance page in Nginx over HTTP and how to test such Nginx configuration with the Bats testing framework."> <meta content="Michal Czeraszkiewicz" name="author"> <meta content="Distributed Web Architecture, Scalable Application Development, Consulting, Trainings by czerasz.com" property="og:site_name"> <meta content="Nginx Maintenance Mode with Integration Testing" property="og:title"> <meta content="article" property="og:type"> <meta content="This article shows how to enable a maintenance page in Nginx over HTTP and how to test such Nginx configuration with the Bats testing framework." property="og:description"> <meta content="http://czerasz.com/2015/04/21/nginx-maintenance-mode/" property="og:url"> <meta content="/img/logo-high-resolution.png" property="og:image"> <meta content="2015-04-21T00:00:00+02:00" property="article:published_time"> <meta content="http://czerasz.com/about/" property="article:author"> <meta content="nginx" property="article:tag"> <meta content="nginx testing" property="article:tag"> <meta content="maintenance" property="article:tag"> <meta content="web server" property="article:tag"> <meta content="bats tutorial" property="article:tag"> <meta content="bash testing" property="article:tag"> <meta content="web server test" property="article:tag"> <meta content="integration testing" property="article:tag"> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@czerasz"> <meta name="twitter:creator" content="@czerasz"> <meta name="twitter:title" content="Nginx Maintenance Mode with Integration Testing"> <meta name="twitter:url" content="http://czerasz.com/2015/04/21/nginx-maintenance-mode/"> <meta name="twitter:description" content="This article shows how to enable a maintenance page in Nginx over HTTP and how to test such Nginx configuration with the Bats testing framework."> <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="/assets/1435603199854/css/bootstrap.min.css" rel="stylesheet"> <link rel="stylesheet" href="/assets/1435603199854/css/main.css"> <link rel="canonical" href="http://czerasz.com/2015/04/21/nginx-maintenance-mode/"> <link rel="alternate" type="application/atom+xml" title="Web IT Services" href="http://czerasz.com/feed.xml" /> <link href='http://fonts.googleapis.com/css?family=Raleway%7CMerriweather' rel='stylesheet' type='text/css'> <link rel="shortcut icon" href="/assets/1435603199854/img/favicons/favicon.ico"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/1435603199854/img/favicons/apple-touch-icon-57x57.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/1435603199854/img/favicons/apple-touch-icon-114x114.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/1435603199854/img/favicons/apple-touch-icon-72x72.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/1435603199854/img/favicons/apple-touch-icon-144x144.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/1435603199854/img/favicons/apple-touch-icon-60x60.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/1435603199854/img/favicons/apple-touch-icon-120x120.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/1435603199854/img/favicons/apple-touch-icon-76x76.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/1435603199854/img/favicons/apple-touch-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/1435603199854/img/favicons/apple-touch-icon-180x180.png"> <link rel="icon" type="image/png" href="/assets/1435603199854/img/favicons/favicon-192x192.png" sizes="192x192"> <link rel="icon" type="image/png" href="/assets/1435603199854/img/favicons/favicon-160x160.png" sizes="160x160"> <link rel="icon" type="image/png" href="/assets/1435603199854/img/favicons/favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="/assets/1435603199854/img/favicons/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/assets/1435603199854/img/favicons/favicon-32x32.png" sizes="32x32"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/1435603199854/img/favicons/mstile-144x144.png"> <meta name="msapplication-square70x70logo" content="/assets/1435603199854/img/favicons/mstile-70x70.png"/> <meta name="msapplication-square150x150logo" content="/assets/1435603199854/img/favicons/mstile-150x150.png"/> <meta name="msapplication-square310x310logo" content="/assets/1435603199854/img/favicons/mstile-310x310.png"/> <meta name="msapplication-wide310x150logo" content="/assets/1435603199854/img/favicons/mstile-310x150.png"/> <meta name='yandex-verification' content='6c277a06e11615e8' /> </head> <body> <div id="home"></div> <header itemscope itemtype="http://schema.org/LocalBusiness"> <nav class="navbar navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a itemprop="url" class="navbar-brand" href="http://czerasz.com/"> www.czerasz.com </a> <!-- <a class="navbar-brand" href="http://czerasz.com/">Web IT Services</a> --> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class=""> <a class="page-link" href="http://czerasz.com/">Home</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/about/">About</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/blog/">Blog</a> </li> <li class=""> <a class="page-link" href="http://czerasz.com/contact/">Contact</a> </li> </ul> </div><!-- /.nav-collapse --> </div><!-- /.container --> </nav> <meta itemprop="name" content="http://czerasz.com"> <meta itemprop="telephone" content="+4917667527905"> <span itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"> <meta itemprop="addressLocality" content="Berlin"> <meta itemprop="addressCountry" content="Germany"></span> <meta itemprop="email" content="contact@czerasz.com"> </header> <div class="container post" style="padding-top: 130px"> <div class="row"> <div class="col-md-9" itemscope itemtype="http://schema.org/Article" > <header class="post-header"> <h1 itemprop="name" class="post-title">Nginx Maintenance Mode with Integration Testing</h1> <p itemprop="dateCreated" content="2015-04-21" class="article__date"><i class="glyphicon glyphicon-time"></i> Apr 21, 2015</p> <meta itemprop="datePublished" content="2015-04-21"> </header> <article itemprop="articleBody" class="post-content"> <p class="post__tldr" itemprop="description">This article shows how to enable a maintenance page in Nginx over HTTP and how to test such Nginx configuration with the Bats testing framework.</p> <h2 id="introduction">Introduction</h2> <p>Whenever possible avoid downtime!</p> <p>However sometimes it just happens so that we need to take our service offline for at least a few minutes of maintenance. To be able to act professionally in such situations we can configure Nginx, the popular web server to show a special maintenance page for all incoming requests. This page will inform users and search engine bots that our site is temporary down and will be back soon.</p> <p>There is a really great <a href="http://www.smashingmagazine.com/2009/06/12/effective-maintenance-pages-examples-and-best-practices/" target="_blank">article about effective maintenance pages</a> with a bunch of tips which allow you to design the perfect maintenance page for your service. Proper communication is as important as a stable technical integration.</p> <p>Let’s quickly go through our plan for today.</p> <p>Our initial situation is presented on the diagram below.</p> <p><img class="post__image--spacy img-responsive" itemprop="image" src="/assets/1435603199854/img/posts/nginx-maintenance-mode/initial-situation.png" alt="Nginx Maintenance Mode: initial situation application request" /></p> <p>For the sake of simplicity I have chosen the simplest scenario - one web application behind an Nginx server. The implementation for a more complex infrastructure is analogous and should be as simple as the one presented in this article. But if you have any troubles feel free to <a href="/contact">contact me</a>. I’m sure I will be able to help.</p> <p>And here comes the best part. With a simple HTTP <code>PUT</code> request we can enable the Nginx’s maintenance mode.</p> <p><img class="post__image--spacy img-responsive" itemprop="image" src="/assets/1435603199854/img/posts/nginx-maintenance-mode/enable-nginx-maintenance-mode-over-http.png" alt="Nginx Maintenance Mode: enable maintenance mode with an http request" /></p> <p>From now on all responses will contain the content of the <code>/usr/share/nginx/html/maintenance.html</code> file and will be returned with the <code>503</code> status code.</p> <p><img class="post__image--spacy img-responsive" itemprop="image" src="/assets/1435603199854/img/posts/nginx-maintenance-mode/nginx-maintenance-mode.png" alt="Nginx Maintenance Mode: how maintenance mode works" /></p> <p>For the full understanding the diagram above contains also the light blue path which represents the normal situation.</p> <p>The maintenance mode persists until we disable it with an HTTP <code>DELETE</code> request.</p> <p><img class="post__image--spacy img-responsive" itemprop="image" src="/assets/1435603199854/img/posts/nginx-maintenance-mode/disable-nginx-maintenance-mode-over-http.png" alt="Nginx Maintenance Mode: disable maintenance mode with an http request" /></p> <p>Now for a better overview let’s see everything at once. The following sequential diagram shows the full situation described in this chapter:</p> <p><img class="post__image--spacy img-responsive" itemprop="image" src="/assets/1435603199854/img/posts/nginx-maintenance-mode/sequential-diagram.png" alt="Nginx Maintenance Mode: sequential diagram" /></p> <p>In this diagram the HTTP <code>PUT</code> and <code>DELETE</code> requests are fetched by the same client for the sake of simplicity. In a real world those requests are only available to the appropriate person/service.</p> <h2 id="preparation-and-infrastructure">Preparation and Infrastructure</h2> <p>The source code for the example presented in this article is available in the <code>0.0.1</code> release of my <a href="https://github.com/czerasz/nginx-configuration-examples/tree/0.0.1" target="_blank">Nginx Configuration Examples Github project</a>.</p> <p>Simply clone the git repository with this command:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone --branch 0.0.1 git@github.com:czerasz/nginx-configuration-examples.git</code></pre></div> <p>The project structure looks like this:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">.
├── bin
│   └── test.sh
├── config
│   ├── htpasswd
│   ├── maintenance-page.conf
│   └── nginx.conf
├── Dockerfile
└── <span class="nb">test</span>
    └── nginx.bats</code></pre></div> <p>It contains:</p> <ul> <li>a helper script inside the <code>bin</code> directory</li> <li>few Nginx configuration files in the <code>config</code> directory</li> <li>test specs and a <code>Dockerfile</code></li> </ul> <p>To be able to follow this tutorial you will just need <a href="https://www.docker.com/" target="_blank">Docker</a> installed on your machine. Follow this <a href="https://docs.docker.com/installation/" target="_blank">installation guide</a> if you haven’t installed Docker so far.</p> <h2 id="the-dockerfile">The <code>Dockerfile</code></h2> <p>We will work on and test our Nginx configuration inside a <a href="https://www.docker.com/" target="_blank">Docker</a> container. This will allow us to keep everything inside a sandbox additionally providing a really fast environment.</p> <p>The mentioned Docker container is created based on the following <a href="https://github.com/czerasz/nginx-configuration-examples/blob/0.0.1/Dockerfile"><code>Dockerfile</code></a>:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno"> 1</span> FROM nginx:1.7.9
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c"># Set the reset cache variable</span>
<span class="lineno"> 4</span> ENV REFRESHED_AT 2015-04-20
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="c"># Update repositories lists and install required tools and libraries</span>
<span class="lineno"> 7</span> RUN apt-get update
<span class="lineno"> 8</span> RUN apt-get install -y wget curl git tree vim htop strace procps
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="c"># Install bats testing framework</span>
<span class="lineno">11</span> RUN git clone https://github.com/sstephenson/bats.git /tmp/bats <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /tmp/bats <span class="o">&amp;&amp;</span> ./install.sh /usr/local
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="c"># Create maintenance content file - this will be returned in maintenance mode</span>
<span class="lineno">14</span> RUN <span class="nb">echo</span> <span class="s1">&#39;Site in maintenance&#39;</span> &gt; /usr/share/nginx/html/maintenance.html
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c"># Nginx owns the web content directory - required to save the maintenance file by WebDAV</span>
<span class="lineno">17</span> RUN chown -R nginx:nginx /usr/share/nginx/html/
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="c"># Add configuration files</span>
<span class="lineno">20</span> ADD ./config/nginx.conf /etc/nginx/nginx.conf
<span class="lineno">21</span> ADD ./config/maintenance-page.conf /etc/nginx/maintenance-page.conf
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="c"># Add the base auth credentials</span>
<span class="lineno">24</span> ADD ./config/htpasswd /etc/nginx/htpasswd
<span class="lineno">25</span> 
<span class="lineno">26</span> <span class="c"># Add test spec</span>
<span class="lineno">27</span> ADD ./test/nginx.bats /</code></pre></div> <p>The <code>Dockerfile</code> should be straight forward because it’s well documented, but here are some things which are worth mentioning:</p> <ul> <li>the line with <code>ENV REFRESHED_AT 2015-04-20</code> is explained in my other article which is available <a href="/2014/11/13/docker-tip-and-tricks/#use-refreshedat-variable-for-better-cache-control" target="_blank">here</a></li> <li>the installed <a href="https://packages.debian.org/sid/procps" target="_blank"><code>procps</code> package</a> (the <code>/proc</code> file system utilities) contains <code>ps</code> and <code>pgrep</code> among many other useful tools. <code>pgrep</code> is used later in our Nginx test catalogue</li> <li>in line <code>11</code> Docker will install the <a href="https://github.com/sstephenson/bats" target="_blank">Bats: Bash Automated Testing System</a>. It’s a simle and easy to use Bash testing framework</li> <li>the <code>/usr/share/nginx/html/maintenance.html</code> contains the maintenance information. If you want to add a nice looking page feel free to use the <code>ADD</code> directive</li> </ul> <h2 id="nginx-configuration">Nginx Configuration</h2> <p>The <a href="https://github.com/czerasz/nginx-configuration-examples/blob/0.0.1/config/nginx.conf" target="_blank"><code>config/nginx.conf</code></a> is the main Nginx configuration file which includes the most important file for us, mainly the <a href="https://github.com/czerasz/nginx-configuration-examples/blob/0.0.1/config/maintenance-page.conf" target="_blank"><code>config/maintenance-page.conf</code></a>.</p> <p>Let’s go through the <code>config/maintenance-page.conf</code> file:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">set</span> <span class="nv">$maintenance</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

location /maintenance-mode <span class="o">{</span>
    limit_except PUT DELETE <span class="o">{</span>
        deny all<span class="p">;</span>
    <span class="o">}</span>
    dav_methods PUT DELETE<span class="p">;</span>

    auth_basic <span class="s2">&quot;Maintenance&quot;</span><span class="p">;</span>
    auth_basic_user_file /etc/nginx/htpasswd<span class="p">;</span>
<span class="o">}</span>

<span class="c"># Note: if is evil only in the location block</span>

<span class="c"># If the request goes to /maintenance-mode ignore the maintenance mode</span>
<span class="k">if</span> <span class="o">(</span> <span class="nv">$uri</span> <span class="o">=</span> <span class="s1">&#39;/maintenance-mode&#39;</span> <span class="o">)</span> <span class="o">{</span>
    <span class="nb">set</span> <span class="nv">$maintenance</span> <span class="s2">&quot;${maintenance}+disable&quot;</span><span class="p">;</span>
<span class="o">}</span>

<span class="c"># Check if the maintenance mode is enabled</span>
<span class="k">if</span> <span class="o">(</span>-f <span class="nv">$document_root</span>/maintenance-mode<span class="o">)</span> <span class="o">{</span>
    <span class="nb">set</span> <span class="nv">$maintenance</span> <span class="s2">&quot;${maintenance}+exists&quot;</span><span class="p">;</span>
<span class="o">}</span>

<span class="c"># If the request goes to anything different than /maintenance-mode return a 503 if the maintenance mode is enabled</span>
<span class="k">if</span> <span class="o">(</span> <span class="nv">$maintenance</span> <span class="o">=</span> <span class="s2">&quot;+exists&quot;</span> <span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> 503<span class="p">;</span> <span class="c"># Service temporarily unavailable</span>
<span class="o">}</span>

error_page <span class="m">503</span> @maintenance<span class="p">;</span>

location @maintenance <span class="o">{</span>
    rewrite ^<span class="o">(</span>.*<span class="o">)</span><span class="nv">$ </span>/maintenance.html <span class="nb">break</span><span class="p">;</span>
<span class="o">}</span></code></pre></div> <p>The <code>/maintenance-mode</code> location block contains directives which enable us to create or remove the <code>/usr/share/nginx/html/maintenance-mode</code> file over HTTP. </p> <p>We can create the file with <code>curl</code>:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">curl -i -u czerasz:password1234567890 -XPUT localhost/maintenance-mode -d <span class="s1">&#39;&#39;</span></code></pre></div> <blockquote> <p><strong>Note</strong> <br />The <code>-u czerasz:password1234567890</code> parameter is responsible for authentication. We could also use this url <code>http://czerasz:password1234567890@localhost/maintenance-mode</code> instead.</p> </blockquote> <p>Or we can delete the file with:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">curl -i -u czerasz:password1234567890 -XDELETE localhost/maintenance-mode</code></pre></div> <blockquote> <p><strong>Note</strong> <br />We are using base authentication which should be improved by enabling SSL.</p> </blockquote> <p>The existence of <code>/usr/share/nginx/html/maintenance-mode</code> tells Nginx if it is in maintenance mode:</p> <ul> <li>if the <code>/usr/share/nginx/html/maintenance-mode</code> file exists then Nginx will respond with a <code>503</code> status code - the service is in maintenance mode</li> <li>if the <code>/usr/share/nginx/html/maintenance-mode</code> file doesn’t exists then Nginx works normally</li> </ul> <p>If the <code>/usr/share/nginx/html/maintenance-mode</code> file exists, Nginx will return the <code>/usr/share/nginx/html/maintenance.html</code> file with the <code>503</code> status code for all requests. The specific status code is important because it tells Google and co that the service is temporarily unavailable. And that they should try it later. I refer to <a href="https://yoast.com/http-503-site-maintenance-seo/" target="_blank">this article</a> which explains why it is so important from the seo perspective.</p> <p>The config contains also few <code>if</code> statements which allow us to do the <code>DELETE</code> request (which was discussed before) in maintenance mode.</p> <h2 id="integration-tests">Integration Tests</h2> <p>Now that we know how our configuration works, it’s time for a success experience. Let’s run our test suite and watch the tests pass:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>./bin/test.sh 
Build the container
Remove the old container
Start the container and run the tests
1..6
ok <span class="m">1</span> Nginx binary is found in /usr/local/libexec:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ok <span class="m">2</span> Nginx is installed in version 1.7.9
ok <span class="m">3</span> Upstream server shouldn<span class="err">&#39;</span>t be available
ok <span class="m">4</span> Nginx should be in maintenance mode <span class="k">if</span> the /usr/share/nginx/html/maintenance-mode exists
ok <span class="m">5</span> Allow the client to create the /usr/share/nginx/html/maintenance-mode file over HTTP
ok <span class="m">6</span> Allow the client to remove the /usr/share/nginx/html/maintenance-mode file over HTTP</code></pre></div> <p>The analysis of our <a href="https://github.com/czerasz/nginx-configuration-examples/blob/0.0.1/bin/test.sh" target="_blank"><code>bin/test.sh</code></a> helper script shows that it works according to this scenario/along those points:</p> <ul> <li>a Docker image is build based on the already discussed <code>Dockerfile</code></li> <li>the previous, old container is removed, if it exists</li> <li>a new container is created based on our build</li> <li>in the newly created container, the <code>bats /nginx.bats</code> command is executed to run our tests</li> <li>the <code>--rm=true</code> parameter tells Docker to remove our container after the tests have finished</li> </ul> <p>We know that our tests pass, so let’s see how they are written. The <a href="https://github.com/czerasz/nginx-configuration-examples/blob/0.0.1/test/nginx.bats" target="_blank"><code>test/nginx.bats</code></a> file which represent our test catalogue, is a simple Bash script which uses the <a href="https://github.com/sstephenson/bats" target="_blank">Bats testing framework</a>: </p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bats</span>

wait_for_nginx<span class="o">()</span> <span class="o">{</span>
  <span class="c"># Start Nginx</span>
  nginx <span class="p">&amp;</span>
  
  <span class="k">while</span> ! pgrep -xf <span class="s2">&quot;nginx: worker process&quot;</span> &gt; /dev/null <span class="p">;</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s1">&#39;wait for nginx&#39;</span>

    sleep 0.1<span class="p">;</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="nv">maintenance_file_path</span><span class="o">=</span>/usr/share/nginx/html/maintenance-mode

teardown<span class="o">()</span> <span class="o">{</span>
  pkill nginx <span class="o">||</span> <span class="nb">true</span>
<span class="nb">  </span>rm -f <span class="nv">$maintenance_file_path</span> <span class="p">&amp;</span>&gt; /dev/null
<span class="o">}</span>

@test <span class="s2">&quot;Nginx binary is found in $PATH&quot;</span> <span class="o">{</span>
  run which nginx

  <span class="o">[</span> <span class="s2">&quot;$status&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="o">}</span>

@test <span class="s2">&quot;Nginx is installed in version 1.7.9&quot;</span> <span class="o">{</span>
  run /usr/sbin/nginx -v

  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;1.7.9&quot;</span>  <span class="o">]]</span>
<span class="o">}</span>

@test <span class="s2">&quot;Upstream server shouldn&#39;t be available&quot;</span> <span class="o">{</span>
  wait_for_nginx

  <span class="nv">result</span><span class="o">=</span><span class="s2">&quot;$(curl -Is http://localhost/ | head -n1 | awk &#39;{print $2}&#39;)&quot;</span>

  <span class="o">[[</span> <span class="s2">&quot;$result&quot;</span> -eq <span class="s1">&#39;502&#39;</span> <span class="o">]]</span>
<span class="o">}</span>

@test <span class="s2">&quot;Nginx should be in maintenance mode if the $maintenance_file_path exists&quot;</span> <span class="o">{</span>
  wait_for_nginx

  touch <span class="nv">$maintenance_file_path</span>
  
  run bash -c <span class="s2">&quot;curl -s -w &#39;%{http_code}&#39; http://localhost/ -o /dev/null&quot;</span>

  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> -eq <span class="s1">&#39;503&#39;</span> <span class="o">]]</span>
<span class="o">}</span>

@test <span class="s2">&quot;Allow the client to create the $maintenance_file_path file over HTTP&quot;</span> <span class="o">{</span>
  wait_for_nginx

  <span class="c"># Shouldn&#39;t be able to create the maintenance file without authentication</span>
  run bash -c <span class="s2">&quot;curl -s -w &#39;%{http_code}&#39; -XPUT localhost/maintenance-mode -d &#39;&#39; -o /dev/null&quot;</span>

  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> -eq <span class="s1">&#39;401&#39;</span> <span class="o">]]</span>

  <span class="c"># File shouldn&#39;t be created yet</span>
  <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$maintenance_file_path&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="o">[[</span> <span class="m">1</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">else</span>
    <span class="o">[[</span> <span class="m">0</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">fi</span>

  <span class="c"># Allow with authentication</span>
  run bash -c <span class="s2">&quot;curl -s -u czerasz:password1234567890 -w &#39;%{http_code}&#39; -XPUT localhost/maintenance-mode -d &#39;&#39; -o /dev/null&quot;</span>

  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> -eq <span class="s1">&#39;201&#39;</span> <span class="o">]]</span>

  <span class="c"># Check if maintenance file was successfully created</span>
  <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$maintenance_file_path&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="o">[[</span> <span class="m">0</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">else</span>
    <span class="o">[[</span> <span class="m">1</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">fi</span>
<span class="o">}</span>

@test <span class="s2">&quot;Allow the client to remove the $maintenance_file_path file over HTTP&quot;</span> <span class="o">{</span>
  wait_for_nginx

  touch <span class="nv">$maintenance_file_path</span>
  chown nginx:nginx <span class="nv">$maintenance_file_path</span>

  <span class="c"># Shouldn&#39;t be able to delete the maintenance file without authentication</span>
  run bash -c <span class="s2">&quot;curl -s -w &#39;%{http_code}&#39; -XDELETE localhost/maintenance-mode -o /dev/null&quot;</span>

  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> -eq <span class="s1">&#39;401&#39;</span> <span class="o">]]</span>

  <span class="c"># File shouldn&#39;t be deleted yet</span>
  <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$maintenance_file_path&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="o">[[</span> <span class="m">0</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">else</span>
    <span class="o">[[</span> <span class="m">1</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">fi</span>

  <span class="c"># Allow with authentication</span>
  run bash -c <span class="s2">&quot;curl -s -u czerasz:password1234567890 -w &#39;%{http_code}&#39; -XDELETE localhost/maintenance-mode -o /dev/null&quot;</span>

  <span class="c"># File should be deleted</span>
  <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$maintenance_file_path&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="o">[[</span> <span class="m">1</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">else</span>
    <span class="o">[[</span> <span class="m">0</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">fi</span>

  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> -eq <span class="s1">&#39;204&#39;</span> <span class="o">]]</span>
<span class="o">}</span></code></pre></div> <p>If you have basic Bash understanding you should be able to easily understand it but let me explain the most important parts.</p> <p>The spec contains <code>@test</code> blocks, variables and functions.</p> <p>The <code>@test</code> block has the following structure:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">@test <span class="s2">&quot;Name of the test&quot;</span> <span class="o">{</span>
  <span class="c"># The test goes here</span>
  run /usr/sbin/nginx -v

  <span class="o">[</span> <span class="s2">&quot;$status&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
  <span class="o">[[</span> <span class="s2">&quot;$output&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;1.7.9&quot;</span>  <span class="o">]]</span>
<span class="o">}</span></code></pre></div> <p>Inside the <code>@test</code> block we can <code>run</code> any command afterwards analysing its output and its exit code.</p> <blockquote> <p><strong>Note</strong> <br />A successful command returns a <code>0</code>, while an unsuccessful one returns a non-zero value.</p> </blockquote> <p>In case of more complex commands I use a <code>bash -c</code> wrapper to encapsulate the entire command as presented in the example below:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash">run bash -c <span class="s2">&quot;curl -s -u czerasz:password1234567890 -w &#39;%{http_code}&#39; -XDELETE localhost/maintenance-mode -o /dev/null&quot;</span></code></pre></div> <p>Because we need to test a web server, what could be better than the <code>curl</code> command to achieve this task? The following parameters have proved to be very useful:</p> <ul> <li><code>-s</code> - silent mode. Don't output anything</li> <li><code>-w '%{http_code}'</code> - return only the status code</li> <li><code>-XPUT</code> - specify the request method</li> <li><code>-d ''</code> - specify the <code>POST</code> request data</li> <li><code>-u user:password</code> - specifies the user and password for the base authentication</li> <li><code>-I</code> - show response status with headers <br /><br /> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -I google.com
HTTP/1.1 <span class="m">302</span> Found
Cache-Control: private
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Location: http://www.google.de/?gfe_rd<span class="o">=</span>cr<span class="p">&amp;</span><span class="nv">ei</span><span class="o">=</span>uBo2VdWMAqSF8Qfex4DACA
Content-Length: 258
Date: Tue, <span class="m">21</span> Apr <span class="m">2015</span> 09:39:04 GMT
Server: GFE/2.0
Alternate-Protocol: 80:quic,p<span class="o">=</span>1</code></pre></div> </li> </ul> <p>Bats has also some conventions. One of them is the <code>teardown</code> function, which is executed after each test case to clean up the environment. In our script the cleanup consists of killing Nginx and removing the <code>/usr/share/nginx/html/maintenance-mode</code> file.</p> <p>You also noticed the <code>wait_for_nginx</code> function which is there to spin up the Nginx process and wait until it’s up. This code could be also wrapped inside the <code>setup</code> helper which is executed before each test.</p> <p>You can read more about the <code>teardown</code> and the <code>setup</code> helpers <a href="https://github.com/sstephenson/bats#setup-and-teardown-pre--and-post-test-hooks" target="_blank">here</a>.</p> <p>In summary our tests consist of Bash commands which are later analysed in Bash for their correctness. </p> <p>Make sure you visit the <a href="https://github.com/sstephenson/bats" target="_blank">Bats Github repository</a> to star this awesome project.</p> <h2 id="performance-considerations">Performance Considerations</h2> <p>Swapping the Nginx configuration file by a another configuration file that contains only the maintenance logic would save Nginx a lot of processing power. I can imagine this could be achieved with <a href="http://www.ansible.com/" target="_blank">Ansible</a> or <a href="https://puppetlabs.com/" target="_blank">Puppet</a> fairly easy. But depending on your situation it might be harder to implement (than a HTTP request) and might also require an additional service/process which makes the architecture more complex. Read, compare features and decide.</p> <h2 id="resources">Resources</h2> <ul> <li><a href="https://github.com/aptible/docker-nginx" target="_blank">Nginx Docker Image</a></li> <li><a href="https://www.youtube.com/watch?v=XGIY9ezIzyE" target="_blank">Youtube: Test Drive Your Config File!</a></li> <li><a href="https://github.com/sstephenson/bats" target="_blank">Bats: Bash Automated Testing System</a></li> <li><a href="https://blog.engineyard.com/2014/bats-test-command-line-tools" target="_blank">How to use Bats to test your command line tools</a></li> </ul> </article> <div class="divider divider--text"> <p class="typography-small">Share</p> </div> <div class="post__social-section clearfix"> <!-- Buttons start here. --> <ul class="rrssb-buttons"> <li class="rrssb-twitter"> <a href="http://twitter.com/share?url=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F&amp;via=czerasz&amp;text=Nginx+Maintenance+Mode+with+Integration+Testing&amp;lang=en&amp;count=none&amp;counturl=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F&amp;hashtags=nginx%2Cnginx testing%2Cmaintenance%2Cweb server%2Cbats tutorial%2Cbash testing%2Cweb server test%2Cintegration testing%2C" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via twitter" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-twitter"></use> </svg> </span> <span class="rrssb-text">twitter</span> </a> </li> <li class="rrssb-googleplus"> <a href="https://plus.google.com/share?url=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F&amp;hl=en-US" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via google plus" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-google-plus"></use> </svg> </span> <span class="rrssb-text">google+</span> </a> </li> <li class="rrssb-linkedin"> <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F&amp;title=Nginx+Maintenance+Mode+with+Integration+Testing&amp;source=czerasz.com+%7C+Web+IT+Services&amp;summary=This+article+shows+how+to+enable+a+maintenance+page+in+Nginx+over+HTTP+and+how+to+test+such+Nginx+configuration+with+the+Bats+testing+framework." target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via linkedin" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-linkedin"></use> </svg> </span> <span class="rrssb-text">linkedin</span> </a> </li> <li class="rrssb-facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via facebook" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-facebook"></use> </svg> </span> <span class="rrssb-text">facebook</span> </a> </li> <li class="rrssb-delicious"> <a href="https://delicious.com/save?v=5&amp;provider=czerasz.com&amp;noui&amp;jump=close&amp;url=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F&amp;title=Nginx+Maintenance+Mode+with+Integration+Testing" target="_blank" class="popup"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="save to delicious" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-delicious"></use> </svg> </span> <span class="rrssb-text">Delicious</span> </a> </li> <li class="rrssb-email"> <a href="mailto:?subject=Epic+article+about%3A+Nginx+Maintenance+Mode+with+Integration+Testing&amp;body=Check+out+this+link%3A+http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F+published+by+Micha%C5%82+Czeraszkiewicz" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via email" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-email"></use> </svg> </span> <span class="rrssb-text">email</span> </a> </li> <li class="rrssb-pocket"> <a href="https://getpocket.com/save?url=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 32 28" class="svg-icon" role="img" aria-label="save to pocket" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-pocket"></use> </svg> </span> <span class="rrssb-text">pocket</span> </a> </li> <li class="rrssb-reddit"> <a href="http://www.reddit.com/submit?url=http%3A%2F%2Fczerasz.com%2F2015%2F04%2F21%2Fnginx-maintenance-mode%2F" target="_blank"> <span class="rrssb-icon"> <svg viewBox="0 0 28 28" class="svg-icon" role="img" aria-label="share via reddit" style='fill: #fff;'> <use xlink:href="/assets/1435603199854/img/svg/social-section.svg#icon-reddit"></use> </svg> </span> <span class="rrssb-text">reddit</span> </a> </li> </ul> <!-- Buttons end here --> </div> <div class="article__author-container" itemprop="author"> <div class="divider divider--text"> <p class="typography-small">Author</p> </div> <img class="article__avatar" src="http://www.gravatar.com/avatar/88954c51cd72a270af461de17fa2e150.png" alt="czerasz avatar" height="80" width="80"> <div class="article__author-info" itemscope itemtype="http://schema.org/Person"> <h4 itemprop="name">Michał Czeraszkiewicz</h4> <p><span itemprop="jobTitle">Full Stack Developer, Consultant</span>. Web technology enthusiast with pashion for web architecture. You can follow him on <a href="https://twitter.com/czerasz" target="_blank">Twitter</a> or <a href="https://plus.google.com/u/0/117800598211330706058?rel=author" target="_blank">Google+</a>.</p> </div> <!-- gem-author-info --> </div> <div class="divider clearfix"></div> <div class="post__navigation-bottom"> <a class="btn btn-default" href="/blog"> <span class="glyphicon glyphicon-chevron-left"></span> back </a> <a class="btn btn-primary" href="#home"> <span class="glyphicon glyphicon-chevron-up"></span> go up </a> </div> <div class="divider clearfix"></div> <section class="callout callout--center"> <h3>Like what You see?</h3> <a class="btn btn-lg btn-primary" href="/contact">Then let us work together!</a> <p>We provide high quality web IT services. From solid front-end architecture, through scalable back-end applications, up to distrubuted data stores. Every piece of your infrastructure is build with passion.</p> </section> </div> </div> </div> <footer class="site-footer"> <div class="site-footer__footer-above"> <div class="container"> <div class="row"> <div class="col-md-4 col-md-offset-4"> <h3>Social</h3> <div class="footer__social-icons"> <a href="https://twitter.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's twitter page"> <use xlink:href="/assets/1435603199854/img/svg/social.svg#icon-twitter"></use> </svg> </a> <a href="https://github.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's github profile page"> <use xlink:href="/assets/1435603199854/img/svg/social.svg#icon-github"></use> </svg> </a> <a href="http://stackoverflow.com/users/325852/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's stackoverflow profile page"> <use xlink:href="/assets/1435603199854/img/svg/social.svg#icon-stackoverflow"></use> </svg> </a> <a href="https://www.linkedin.com/in/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's linkedin profile page"> <use xlink:href="/assets/1435603199854/img/svg/social.svg#icon-linkedin"></use> </svg> </a> <a href="https://delicious.com/czerasz"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's delicious profile page"> <use xlink:href="/assets/1435603199854/img/svg/social.svg#icon-delicious"></use> </svg> </a> <a href="https://plus.google.com/u/0/117800598211330706058?rel=author"> <svg viewBox="0 0 30 30" class="svg-icon" role="img" aria-label="czerasz's google plus profile page"> <use xlink:href="/assets/1435603199854/img/svg/social.svg#icon-google-plus"></use> </svg> </a> </div> <div class="divider divider--border visible-xs-block visible-sm-block"></div> </div> <div class="col-md-4"> <h3>About</h3> <p>Solid knowledge about web and web-technologies. Focused on Back-End, Front-End and DevOps topics. Docker, Python, Nginx, Linux, IT-Architecture, Vagrant, Ansible, MongoDB and Elasticsearch. </p> <a class="btn btn-default pull-right" style="margin-top: 20px" href="/about/">read more</a> </div> </div> </div> </div> <div class="site-footer__footer-below"> <div class="container"> <div class="row"> <div class="col-md-12"> <p class="text-center">© 2015 &middot; czerasz &middot; All Rights Reserved | Made with &hearts; in Berlin</p> </div> </div> </div> </div> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> <script src="/assets/1435603199854/js/bootstrap.min.js"></script> <script src="/assets/1435603199854/vendor/RRSSB/js/rrssb.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-18008380-5', 'auto'); ga('send', 'pageview'); </script> </body> </html>
