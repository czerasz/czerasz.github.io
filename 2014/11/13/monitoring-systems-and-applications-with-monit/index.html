<!DOCTYPE html>
<html>


  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Monitoring Systems and Applications with Monit</title>
  <meta name="description" content="In this article we will focus on Monit which is a system monitoring and error recovery tool. We will also cover the topic of deploying Monit's configuration ...">

  
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
  

  
  

   
  <link rel="stylesheet" href="/assets/1419845847752/css/main.css">
  
  <link rel="canonical" href="http://staging.1bcb8bfcfd5e642fb66700117faa5786.czerasz.com/2014/11/13/monitoring-systems-and-applications-with-monit/">
  <link rel="alternate" type="application/atom+xml" title="Web IT Services" href="http://staging.1bcb8bfcfd5e642fb66700117faa5786.czerasz.com/feed.xml" />

  <link href='http://fonts.googleapis.com/css?family=Raleway|Merriweather' rel='stylesheet' type='text/css'>
</head>

  <body>
    


<div id="home"></div>

<header>

<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="navbar-brand" href="/">
        www.czerasz.com
      </a>
      <!-- <a class="navbar-brand" href="/">Web IT Services</a> -->
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        
          <li class="">
            <a class="page-link" href="/">Home</a>
          </li>
        
          <li class="">
            <a class="page-link" href="/about/">About</a>
          </li>
        
          <li class="">
            <a class="page-link" href="/blog/">Blog</a>
          </li>
        
          <li class="">
            <a class="page-link" href="/contact/">Contact</a>
          </li>
        
      </ul>
      


    </div><!-- /.nav-collapse -->
  </div><!-- /.container -->
</nav>

</header>

    <div class="container  post" style="padding-top: 130px">
    <div class="row">
        <div class="col-md-9">

              <header class="post-header">
                <h1 class="post-title">Monitoring Systems and Applications with Monit</h1>
                <p class="article__date"><i class="glyphicon  glyphicon-calendar"></i> Nov 13, 2014</p>
                
              </header>

              <article class="post-content">
                <p class="post__tldr">In this article we will focus on <a href="https://mmonit.com/monit/" target="_blank">Monit</a> which is a system monitoring and error recovery tool. We will also cover the topic of deploying Monit's configuration files with Ansible.</p>

<p>Let’s start with a simple question:</p>

<blockquote>
  <p>What is actually worth to be monitored?</p>
</blockquote>

<p>Luckily the answer is also simple:</p>

<blockquote>
  <p>Everything what is critical to our business.</p>
</blockquote>

<p>At application, service level it could be:</p>

<ul>
  <li>process existence</li>
  <li>is the process responding on a given port</li>
  <li>resources consumption</li>
  <li>configuration file changes</li>
  <li>logfiles existence</li>
</ul>

<p>At system level one should consider the following:</p>

<ul>
  <li>filesystem checks</li>
  <li>network monitoring</li>
  <li>CPU monitoring</li>
</ul>

<p>All those tasks can be accomplished with Monit, because it’s able to monitor:</p>

<ul>
  <li>Files and Directories</li>
  <li>Disks</li>
  <li>Processes</li>
  <li>System</li>
  <li>Hosts</li>
</ul>

<h2 id="installation">Installation</h2>

<h3 id="monit-installation-on-gentoo">Monit Installation on Gentoo</h3>

<p>Install Monit on Gentoo with the following command:</p>

<pre><code>emerge monit
</code></pre>

<p>On Gentoo You can always do a installation dry-run:</p>

<pre><code>emerge --pretend monit
</code></pre>

<blockquote>
  <p><strong>Note</strong>
<br />This basically says what would happen if You would install the given package</p>
</blockquote>

<h3 id="installation-from-source">Installation From Source</h3>

<blockquote>
  <p><strong>Note</strong>
<br />Most packages (like the one on Ubuntu - contains Monit 5.6) are out of date. That’s why it’s recommended to install Monit from source.</p>
</blockquote>

<p>Analyse <a href="https://registry.hub.docker.com/u/czerasz/monit-base/">this</a> Docker image to learn how to install Monit on Ubuntu from source.</p>

<p>If you don’t want to visit that link, here is a short version:</p>

<pre><code>apt-get install -y libssl-dev
cd /tmp/
curl 'https://mmonit.com/monit/dist/monit-5.10.tar.gz' -O
tar -xzvf monit-5.10.tar.gz
rm monit-5.10.tar.gz
cd monit-5.10/
./configure --bindir=/usr/bin/
make &amp;&amp; make install
# Create required files
mkdir -p /var/lib/monit
# Make the init file executable
chmod 755 /etc/init.d/monit
</code></pre>

<h2 id="file-structure">File Structure</h2>

<p>All Monit configuration files are kept inside of the <code>/etc/monit</code> directory.</p>

<p>A standard file structure, to which I got used to looks like this:</p>

<pre><code>/etc/monit
├── conf.d       - Monit configuration files
│   ├── apps     - in-house applications
│   ├── services - services like nginx, elasticsearch
│   ├── sys      - system related
│   └── disabled - all disabled
├── bin          - start/stop scripts
│   └── services - services like nginx, elasticsearch
├── monitrc      - main configuration file
├── monitrc.d    - directory with examples
└── templates
</code></pre>

<blockquote>
  <p><strong>Note</strong>
<br />I assume that the application start/stop scripts are deployed together with the application codebase. 
<br />This way if developers change somethig in the application, Monit scripts don’t need to be adjusted (convention over configuration).
<br /><br /><strong>Just remember to force this standard.</strong></p>
</blockquote>

<h2 id="application-monitoring-script-template">Application Monitoring Script Template</h2>

<p>A typical Monit scripts consists of the following parts:</p>

<ul>
  <li>binaries monitoring</li>
  <li>configuration files monitoring</li>
  <li>log files monitoring</li>
</ul>

<p>An example is presented below:</p>

<pre><code># Monit &lt;application name&gt; configuration

check &lt;application name&gt; matching "&lt;phrase which should exits in the ps output&gt;"
    start program = "/bin/su &lt;user&gt; -c '/usr/lib/&lt;application name&gt;/current/bin/start.sh'"
    stop program  = "/bin/su &lt;user&gt; -c '/usr/lib/&lt;application name&gt;/current/bin/stop.sh'"
    # CPU
    if cpu &gt; 5% for 2 cycles then alert
    # RAM
    if mem &gt; 80 MB for 5 cycles then alert

# Check if the application directory exists
check directory &lt;application name&gt;-dir path /usr/lib/&lt;application name&gt;/current/
    if failed uid &lt;user&gt; then alert
    if failed gid &lt;user&gt; then alert
    if failed permission 0755 then alert
    if does not exist then alert

# --- --- --- --- --- --- --- --- --- --- --- --- 
# Configuration
# Check if the configuration directory is present
check &lt;application name&gt;-conf-dir path /usr/lib/&lt;application name&gt;/current/config/
    if failed uid &lt;user&gt; then alert
    if failed gid &lt;user&gt; then alert
    if failed permission 0775 then alert
    if does not exist then alert

# Check if the unicorn configuration file is present
check &lt;application name&gt;-conf-file-unicorn with path /usr/lib/&lt;application name&gt;/current/config/unicorn.rb
    if failed uid &lt;user&gt; then alert
    if failed gid &lt;user&gt; then alert
    if failed permission 0775 then alert
    if does not exist then alert
    if changed checksum then alert

# --- --- --- --- --- --- --- --- --- --- --- --- 
# Logs
# Check if the log file is present
check file &lt;application name&gt;-log-file path /var/log/&lt;application name&gt;/access.log
    if failed uid &lt;user&gt; then alert
    if failed gid &lt;user&gt; then alert
    if failed permission 0644 then alert
    if does not exist then alert
</code></pre>

<p>I would recommend to spend some time with Monit’s <a href="http://mmonit.com/monit/documentation/monit.html">documentation</a>.</p>

<h2 id="startstop-scripts">Start/Stop Scripts</h2>

<p>We all know that each application need an start script. The reason for that is the situation when the server get’s rebooted. The application should be able to come up automatically.</p>

<p>A good practice is to put the start/stop scripts to the same directory where the application is deployed.</p>

<blockquote>
  <p><strong>Note</strong>
<br />The deployment should be adjusted so that it don’t interfere with Monit</p>
</blockquote>

<h3 id="start-scripts-for-ruby-applications">Start Scripts for Ruby Applications</h3>

<p>A sample Ruby start script template which uses <a href="http://rvm.io/">RVM</a> is presented below:</p>

<pre><code>#!/bin/bash

# &lt;application name&gt; Start Script
# This script is executed by the "&lt;user&gt;" user

# Define the project directory
project_directory='/home/&lt;user&gt;/&lt;application name&gt;'

# Define ruby related details
ruby_version='ruby-2.0.0-p195'
ruby_gemset='&lt;gemset name&gt;'


# Start the application server
env LANG='en_US.UTF-8' \
rvm_path=$HOME/.rvm/ \
$HOME/.rvm/bin/rvm-shell \
"$ruby_version@$ruby_gemset" \
-c "cd $project_directory/current; RAILS_ENV=production $project_directory/current/bin/unicorn -c $project_directory/current/config/unicorn.rb -E production -D"
</code></pre>

<p>And just the relevant part for a <a href="http://www.sinatrarb.com/">Sinatra</a> application:</p>

<pre><code># Start the application server
env LANG='en_US.UTF-8' \
rvm_path=$HOME/.rvm/ \
$HOME/.rvm/bin/rvm-shell \
"$ruby_version@$ruby_gemset" \
-c "cd $project_directory/current; bundle exec rackup $project_directory/current/config.ru --env staging --pid $project_directory/current/tmp/pids/sinatra.pid --port 8080  &gt;&gt; /var/log/&lt;application name&gt;/out.log 2&gt;&gt; /var/log/&lt;application name&gt;/error.log &amp;"
</code></pre>

<p>The most important part here is the usage of <code>rvm-shell</code> which syntax looks like this:</p>

<pre><code>rvm-shell "&lt;ruby version&gt;@&lt;ruby gemset&gt;" -c "&lt;command which starts the ruby process&gt;"
</code></pre>

<h2 id="debugging-monit-configurations">Debugging Monit Configurations</h2>

<p>Now that we know where to put our configuration files let’s see how we can debug/test them.</p>

<p>The first thing we need to do is adjust Monit’s poll cycle length in the <code>/etc/monit/monitrc</code> file: </p>

<pre><code>set daemon 10 # Number in seconds
</code></pre>

<p>This value represents the time which Monit sleeps after each check. We need to keep it low for debugging purposes.</p>

<p>Then add a configuration file <code>/etc/monit/conf.d/apps/monit-test-app.conf</code> with the following content:</p>

<pre><code>check process monit-test-app with pidfile "/usr/lib/monit-test-app/pids/process.pid"
  start = "/usr/lib/monit-test-app/bin/start.sh"
  if does not exist then start
</code></pre>

<p>Enable it by adding the following line to <code>/etc/monit/monitrc</code>:</p>

<pre><code>include /etc/monit/conf.d/apps/*.conf
</code></pre>

<p>Our application start script is located under <code>/usr/lib/monit-test-app/bin/start.sh</code> and looks like this:</p>

<pre><code>#!/bin/bash

application_name='monit-test-app'
script_dirirectory="$( cd "$( dirname "$0" )" &amp;&amp; pwd )"
application_dirirectory=$script_dirirectory/..

log_file="/var/log/$application_name/stdout.log"
pid_file="/var/run/$application_name.pid"
 
echo -e "\n`date +"%y%m%d %H:%M:%S"` - start script" &gt;&gt; $log_file
 
echo $BASHPID &gt;&gt; $pid_file
 
echo "`date +"%y%m%d %H:%M:%S"` - sleep 5s" &gt;&gt; $log_file
sleep 5
 
echo "`date +"%y%m%d %H:%M:%S"` - remove pid file" &gt;&gt; $log_file
rm $pid_file
</code></pre>

<blockquote>
  <p><strong>Note</strong>
<br />Remember to make the script executable <code>chmod u+x /usr/lib/monit-test-app/bin/start.sh</code></p>
</blockquote>

<p>Finally start Monit with (if not already started):</p>

<pre><code>service monit start # or: /etc/init.d/monit start
</code></pre>

<p>And reload Monit’s configuration:</p>

<pre><code>monit reload
</code></pre>

<p>Monit should start the <code>start.sh</code> over and over again.</p>

<p>Check if Monit does it’s job by checking the logs:</p>

<pre><code>$ tail -f /var/log/monit.log /var/log/monit-test-app/*
==&gt; /var/log/monit.log &lt;==
[UTC Nov 27 08:07:57] error    : 'monit-test-app' process is not running
[UTC Nov 27 08:07:57] info     : 'monit-test-app' start: /usr/lib/monit-test-app/bin/start.sh

==&gt; /var/log/monit-test-app/stdout.log &lt;==

141127 08:07:57 - start script
141127 08:07:57 - sleep 5s
141127 08:08:02 - remove pid file

==&gt; /var/log/monit.log &lt;==
[UTC Nov 27 08:08:27] error    : 'monit-test-app' failed to start (exit status 0) -- no output
[UTC Nov 27 08:08:37] error    : 'monit-test-app' process is not running
[UTC Nov 27 08:08:37] info     : 'monit-test-app' start: /usr/lib/monit-test-app/bin/start.sh
</code></pre>

<p>I also like to keep an eye on Monit’s summary in a separate terminal:</p>

<pre><code>$ watch -n1 'monit summary'
Every 1.0s: monit summary                                                                                                                                                            Thu Nov 27 00:47:43 2014

The Monit daemon 5.10 uptime: 26m

Process 'monit-test-app'            Execution failed
System '6934259efb99'               Running
</code></pre>

<p>Sometimes it’s helpful to run Monit in a verbose mode. Simply change the init file with this command:</p>

<pre><code>sed -i 's/^MONIT_OPTS=$/MONIT_OPTS="-v"/' /etc/init.d/monit
</code></pre>

<p>And restart Monit so that the change can take place:</p>

<pre><code>service monit restart
</code></pre>

<h2 id="useful-monit-commands">Useful Monit Commands</h2>

<ul>
  <li>
    <p>List all commands</p>

    <pre><code>  monit -h
</code></pre>
  </li>
  <li>
    <p>Get Monit summary</p>

    <pre><code>  monit summary
</code></pre>
  </li>
  <li>
    <p>Disable/unmonitor a service</p>

    <pre><code>  monit unmonitor &lt;service name&gt;
</code></pre>

    <p>If You want to disable the service permanently You can move the appropriate file to the <code>/etc/monit/conf.d/disabled</code> directory and then reload Monit with</p>

    <pre><code>  monit reload
</code></pre>
  </li>
  <li>
    <p>View Monit logs</p>

    <pre><code>  tail -f /var/log/monit.log
</code></pre>
  </li>
</ul>

<h2 id="deploying-monit-configuration-with-ansible">Deploying Monit Configuration with Ansible</h2>

<p>Why Ansible?</p>

<ul>
  <li>because of it’s easy yaml configuration</li>
  <li>because it comes with a good predefined server structure</li>
</ul>

<blockquote>
  <p><strong>Note</strong>
<br />Note Monit has to be configured through the root user. Use <code>sudo su -</code> to login as root user.</p>
</blockquote>

<p>Resources:</p>

<ul>
  <li><a href="https://github.com/edx/configuration/wiki/Ansible-variable-conventions-and-overriding-defaults">Ansible Variables</a></li>
  <li><a href="http://www.tecmint.com/how-to-install-and-setup-monit-linux-process-and-services-monitoring-program/">How to Install and Setup Monit</a></li>
  <li><a href="http://stackoverflow.com/questions/3356476/debugging-monit">Debugging monit</a></li>
</ul>

              </article>

              <div class="article__author-container">
    <div class="divider  divider--text">
        <p class="typography-small">Author</p>
    </div>

    <img class="article__avatar" src="http://www.gravatar.com/avatar/88954c51cd72a270af461de17fa2e150.png" alt="czerasz avatar" height="80" width="80">

    <div class="article__author-info">
        <h4>Michał Czeraszkiewicz</h4>
        <p>Full Stack Developer, Consultant. Web technology enthusiast with pashion for web architecture. You can follow him on <a href="https://twitter.com/czerasz" target="_blank">Twitter</a>  or <a href="" target="_blank">Google+</a>.</p>
    </div> <!-- gem-author-info --> 
</div>

              <div class="divider  clearfix"></div>

              <div class="post__navigation-bottom">
                <a class="btn  btn-default" href="/blog">
                  <span class="glyphicon glyphicon-chevron-left"></span>
                  back
                </a>
                <a class="btn  btn-primary" href="#home">
                  <span class="glyphicon glyphicon-chevron-up"></span>
                  go up
                </a>
              </div>

              <div class="divider  clearfix"></div>              

              <section class="callout  callout--center">
    <h3>Like what You see?</h3>

    <a class="btn  btn-lg  btn-primary" href="/contact">Then let us work together!</a>

    <p>We provide high quality web IT services. From solid front-end architecture, through scalable back-end applications, up to distrubuted data stores. Every piece of your infrastructure is build with passion.</p>
</section>
        </div>
    </div>
</div>

    <footer class="site-footer">
  <div class="site-footer__footer-above">
    <div class="container">
      <div class="row">
      

        <div class="col-md-4  col-md-offset-4">
          <h3>Social</h3>

          <div class="footer__social-icons">
            <a href="https://twitter.com/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's twitter page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-twitter"></use>
              </svg>
            </a>
            <a href="https://github.com/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's github profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-github"></use>
              </svg>
            </a>
            <a href="http://stackoverflow.com/users/325852/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's stackoverflow profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-stackoverflow"></use>
              </svg>
            </a>
            <a href="https://www.linkedin.com/in/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's linkedin profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-linkedin"></use>
              </svg>
            </a>
            <a href="https://delicious.com/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's delicious profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-delicious"></use>
              </svg>
            </a>
            <a href="#">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's google plus profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-google-plus"></use>
              </svg>
            </a>
          </div>

          <div class="divider  divider--border  visible-xs-block  visible-sm-block"></div>
        </div>
        <div class="col-md-4">
          <h3>About</h3>
          <p>Solid knowledge about web and web-technologies. Focused on Back-End, Front-End and DevOps topics. Docker, Python, Nginx, Linux, IT-Architecture, Vagrant, Ansible, MongoDB and Elasticsearch.
</p>
          <a class="btn  btn-default  pull-right" style="margin-top: 20px" href="/about/">read more</a>
        </div>
      </div>
    </div>
  </div>

  <div class="site-footer__footer-below">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <p class="text-center">© 2015 &middot; czerasz &middot; All Rights Reserved
          
          |
          Made with &hearts; in Berlin</p>
        </div>
      </div>
    </div>
  </div>
</footer>

    
    <script src="/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    


    


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18008380-5', 'auto');
  ga('send', 'pageview');
</script>
  </body>

</html>