<!DOCTYPE html>
<html>


  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Docker Tips & Tricks</title>
  <meta name="description" content="This article will cover some really cool techniques and useful tricks which I learned during developing Docker containers.">

  
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
  

  
  

   
  <link rel="stylesheet" href="/assets/1419845847752/css/main.css">
  
  <link rel="canonical" href="http://staging.1bcb8bfcfd5e642fb66700117faa5786.czerasz.com/2014/11/13/docker-tip-and-tricks/">
  <link rel="alternate" type="application/atom+xml" title="Web IT Services" href="http://staging.1bcb8bfcfd5e642fb66700117faa5786.czerasz.com/feed.xml" />

  <link href='http://fonts.googleapis.com/css?family=Raleway|Merriweather' rel='stylesheet' type='text/css'>
</head>

  <body>
    


<div id="home"></div>

<header>

<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="navbar-brand" href="/">
        www.czerasz.com
      </a>
      <!-- <a class="navbar-brand" href="/">Web IT Services</a> -->
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        
          <li class="">
            <a class="page-link" href="/">Home</a>
          </li>
        
          <li class="">
            <a class="page-link" href="/about/">About</a>
          </li>
        
          <li class="">
            <a class="page-link" href="/blog/">Blog</a>
          </li>
        
          <li class="">
            <a class="page-link" href="/contact/">Contact</a>
          </li>
        
      </ul>
      


    </div><!-- /.nav-collapse -->
  </div><!-- /.container -->
</nav>

</header>

    <div class="container  post" style="padding-top: 130px">
    <div class="row">
        <div class="col-md-9">

              <header class="post-header">
                <h1 class="post-title">Docker Tips & Tricks</h1>
                <p class="article__date"><i class="glyphicon  glyphicon-calendar"></i> Nov 13, 2014</p>
                
              </header>

              <article class="post-content">
                <p class="post__tldr">This article will cover some really cool techniques and useful tricks which I learned during developing <a href="https://www.docker.com/" target="_blank">Docker</a> containers.</p>

<h2 id="make-use-of-dockers-cache">Make Use of Docker’s Cache</h2>

<p>Docker saves each commit (each <code>RUN</code>) in a separate layer. Make use of this caching mechanism while planning your application containers.</p>

<p>Let’s consider an PHP application example. The libraries for this application are installed through the <a href="https://getcomposer.org/">Composer</a> package manager. To make use of the cache we will add the following to our <code>Dockerfile</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1</span> <span class="c"># Install libraries through composer</span>
<span class="lineno">2</span> <span class="c"># Until the composer.json</span>
<span class="lineno">3</span> ADD ./app/composer.json /usr/lib/composer/composer.json
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="c"># Install all Wordpress dependencies</span>
<span class="lineno">6</span> ENV COMPOSER_HOME <span class="s1">&#39;/usr/lib/composer&#39;</span>
<span class="lineno">7</span> RUN <span class="nb">cd</span> /usr/lib/composer <span class="o">&amp;&amp;</span> composer install</code></pre></div>

<p>Later in our <a href="#what-is-a-docker-startinit-script">Docker start/init script</a> (which is used while running the container) we symlink those files/libraries where they are supposed to be:</p>

<pre><code># Create symlinks to libraries downloaded through composer
ln -s /usr/lib/composer/vendor /var/www/vendor
</code></pre>

<p>This allows us to spin up containers really fast!</p>

<p>If we would run <code>composer install</code> for the first time in our <a href="#what-is-a-docker-startinit-script">start/init script</a> the run process would take at least as long as the <code>composer install</code>, which usually takes a lot of time.</p>

<blockquote>
  <p><strong>Note</strong>
<br />This scenario implies that a container is build for a specific application.</p>
</blockquote>

<p>Read more about this technique <a href="http://bitjudo.com/blog/2014/03/13/building-efficient-dockerfiles-node-dot-js/">here</a>.</p>

<h2 id="minimize-commitlayer-number-wisely">Minimize Commit/Layer Number… Wisely</h2>

<p>Remember that each commit represents a separate file system layer and that the number of commits is limited.</p>

<p>You can check the maximum limit of commits with the following script:</p>

<pre><code># Remove the commit if it exists
docker rmi czerasz/aufs-layers-test

# Create a base container
docker run --name="aufs-layers-test-container" \
           ubuntu /bin/mkdir /data

# Commit the changes to a new image
docker commit --message='First commit' 'aufs-layers-test-container' czerasz/aufs-layers-test

# Remove the container
docker rm 'aufs-layers-test-container'

for i in {1..1000}
do

echo -e "\n$i build\n"

# Add another commit
cat &lt;&lt;-EOF |
FROM czerasz/aufs-layers-test

RUN /bin/echo -e "test\n" &gt;&gt; /data/test
EOF
docker build -t czerasz/aufs-layers-test -

done
</code></pre>

<p>On my machine it returned:</p>

<pre><code>Cannot create container with more than 127 parents
</code></pre>

<p>Which means that there are only <code>127</code> commits possible.</p>

<p>This is the reason why one should combine the <code>RUN</code> commands in the <code>Dockerfile</code>.</p>

<p>A real word example (which I use in <a href="https://registry.hub.docker.com/u/czerasz/base/">my base image</a>) is presented below:</p>

<pre><code>RUN apt-get install -y build-essential &amp;&amp; \
    apt-get install -y software-properties-common &amp;&amp; \
    apt-get install -y pwgen \
                       python-software-properties \
                       vim \
                       curl \
                       wget \
                       git \
                       unzip \
                       tree
</code></pre>

<p>The downside of this construction is that whenever I need to remove/add a package, Docker is not able to use it’s cache feature and all packages need to be installed from the scratch. And this takes time.</p>

<h2 id="separate-installation-and-configuration">Separate Installation and Configuration</h2>

<p>Add configuration files in the <code>Dockerfile</code> as late as possible. The configuration is something which changes quite often and it would revalidate the cache with each change.</p>

<p>Analyze this Wordpress <code>Dockerfile</code> as an example:</p>

<pre><code># --- PHP ---

# Install PHP
RUN apt-get install -y php5-fpm \
                       php5-mysql \
                       php-apc

# Wordpress Requirements
RUN apt-get install -y php5-curl \
                       php5-gd \
                       php5-intl \
                       php-pear \
                       php5-imagick \
                       php5-imap \
                       php5-mcrypt \
                       php5-memcache \
                       php5-ming \
                       php5-ps \
                       php5-pspell \
                       php5-recode \
                       php5-sqlite \
                       php5-tidy \
                       php5-xmlrpc \
                       php5-xsl

# --- NGINX ---

....

# ------ PHP-FPM CONFIGURATION ------
RUN mkdir -p /var/log/php5-fpm/
# Configure the php5-fpm  process and the default pool
ADD ./config/php-fpm/php-fpm.conf /etc/php5/fpm/php-fpm.conf
ADD ./config/php-fpm/pool.d/www.conf /etc/php5/fpm/pool.d/www.conf
ADD ./config/php-fpm/php.ini /etc/php5/fpm/php.ini
</code></pre>

<p>When we change the PHP configuration the build process will still work really fast, because the most time consuming part, the package installation is cached.</p>

<p>I even tend to split the installation and configuration between separate <code>Dockerfiles</code>.</p>

<h2 id="always-name-containers">Always Name Containers</h2>

<p>While running a new containers rigorously use the <code>--name=</code> option. This way you will always know what this container was ment for.</p>

<p>Some real world examples are presented below:
- <code>czerasz-web</code>
- <code>czerasz-database</code>
- <code>czerasz-data-container</code></p>

<blockquote>
  <p><strong>Note</strong>
<br />A human readable name is very useful while linking containers and while working with data containers.</p>
</blockquote>

<h2 id="use-refreshedat-variable-for-better-cache-control">Use <code>REFRESHED_AT</code> Variable for Better Cache Control</h2>

<p>Consider the following <code>Dockerfile</code>:</p>

<pre><code>FROM ubuntu

# Set the reset cache variable
ENV REFRESHED_AT 2014-11-01

...
</code></pre>

<p>By changing the value of the <code>REFRESHED_AT</code> variable you are able to flush the whole cache.</p>

<h2 id="use-a-supervisor-for-multiple-proccesses">Use a Supervisor for Multiple Proccesses</h2>

<p>If Your container wraps multiple applications/processes use a process control system tool like <a href="http://supervisord.org/"><code>supervisord</code></a>.</p>

<p>A sample <code>/etc/supervisor/conf.d/supervisord.conf</code> which manages Serf, PHP-FPM, Nginx is presented below:</p>

<pre><code>[supervisord]
pidfile=/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)
nodaemon=true                ; (start in foreground if true;default false)


[program:php5-fpm]
command=/usr/sbin/php5-fpm -c /etc/php5/fpm
autorestart=true

[program:nginx]
command=nginx
autostart=true
autorestart=true

[program:serf]
command=/etc/serf/serf-start.sh
numprocs=1
autostart=true
autorestart=true

[program:serf-join]
command=/etc/serf/serf-join.sh
autorestart=true
exitcodes=0
</code></pre>

<h2 id="use-image-inheritance">Use Image Inheritance</h2>

<p>Don’t be afraid of creating Docker images. Separate your logic into different images which inherit from each other.</p>

<p>An example is presented below:</p>

<p><code>ubuntu:latest</code> → <code>czerasz/base</code> → <code>czerasz/wordpress-base</code> → <code>czerasz/czerasz-wordpress-blog</code></p>

<h2 id="use-data-containers">Use Data Containers</h2>

<p>A data container is a concept which is based on a simple idea to keep the data in a special container.</p>

<p>Then by using the option <code>--volumes-from</code> we attach the files from the data container to our application/database container.</p>

<p>The data container’s status will be <code>Exited</code> but don’t fear that someone will delete it by accident. Until it’s used by another container the command <code>docker rm data-container</code> will not work.</p>

<p>A real word example is a Wordpress Docker setup in which the uploads are kept in a separate data container. Let’s see how it works!</p>

<p>Create data container:</p>

<pre><code>docker run -v /data/uploads \
           --name czerasz-data-container \
           -d debian chown -R www-data:www-data /data/uploads
</code></pre>

<p>Create a Wordpress container and attach to it the <code>/data/uploads</code> directory from the data container:</p>

<pre><code>docker run \
       -v `pwd`/app:/var/www \
       --volumes-from czerasz-data-container \
       --link czerasz-database:db \
       -p 80:80 \
       --name czerasz-site \
       -d czerasz/wordpress-base \
       /usr/local/bin/init.sh production
</code></pre>

<blockquote>
  <p><strong>Tip</strong>
<br />Access data container files like this: </p>

  <pre><code>$ ls -al `docker inspect -f '' czerasz-data-container`
drwx------ 4 www-data www-data 4096 Nov  1 22:04 .
drwx------ 3 root     root     4096 Nov  1 20:14 ..
drwx------ 8 www-data www-data 4096 Nov  2 01:25 2014
</code></pre>
</blockquote>

<p>Read more about data containers <a href="https://docs.docker.com/userguide/dockervolumes/">here</a>.</p>

<h2 id="use-files-for-environment-variables">Use Files for Environment Variables</h2>

<p>If you have a lot of environment varaiables which need to be passed to the container use the <code>--env-file</code> option. It allows you to import variables from a file formated like this:</p>

<pre><code>primary=mongo_1532
number_of_replicas=3
...
</code></pre>

<h2 id="always-remove-temporary-containers">Always Remove Temporary Containers</h2>

<p>There is always a situation when you need a container just for a small tasks. It could be checking a specific command, exporting files from a data container or creating a database dump.</p>

<p>Remember to use the <code>--rm</code> option. It will remove the container after it’s job is done and you will never have to deal with a container necropolis after calling <code>docker ps -a</code>.</p>

<p>A real world example (which was borrowed from <a href="https://registry.hub.docker.com/_/mysql/">here</a>) is presented below:</p>

<pre><code>docker run -it \
            --link some-mysql:mysql \
            --rm mysql sh -c 'exec mysql -h"$MYSQL_PORT_3306_TCP_ADDR" -P"$MYSQL_PORT_3306_TCP_PORT" -uroot -p"$MYSQL_ENV_MYSQL_ROOT_PASSWORD"'
</code></pre>

<h2 id="simplify-communication-by-using-the-hostname">Simplify Communication by Using the Hostname</h2>

<p>Whenever you can, use the <code>-h, --hostname=""</code> option to give your container a logical hostname. This will make networking tasks much easier.</p>

<p>The example below shows a simple usecase. First we spin up a server container:</p>

<pre><code>docker run --hostname="web-server" \
           --rm \
           --name host-communication-test-web-server \
           -it ubuntu bash

root@web-server:/# echo "Response from: "`hostname` &gt; index.html &amp;&amp; python3 -m http.server 8000
</code></pre>

<p>Then we spin up a client server which requests the web server:</p>

<pre><code>docker run --hostname="web-client" \
           --rm \
           --link host-communication-test-web-server:web-server \
           -it ubuntu bash 

root@web-client:/# apt-get update &amp;&amp; apt-get install -y curl
root@web-client:/# curl -v web-server:8000/index.html
* Hostname was NOT found in DNS cache
*   Trying 172.17.1.57...
* Connected to web-server (172.17.1.57) port 8000 (#0)
&gt; GET /index.html HTTP/1.1
&gt; User-Agent: curl/7.35.0
&gt; Host: web-server:8000
&gt; Accept: */*
&gt; 
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Server: SimpleHTTP/0.6 Python/3.4.0
&lt; Date: Tue, 25 Nov 2014 11:41:52 GMT
&lt; Content-type: text/html
&lt; Content-Length: 26
&lt; Last-Modified: Tue, 25 Nov 2014 11:40:14 GMT
&lt; 
Response from: web-server
* Closing connection 0
</code></pre>

<p>As you can see we don’t have to use any environment variables (which we by the way don’t have if no port is exposed). We can just rely on the hostname.</p>

<h2 id="what-is-a-docker-startinit-script">What is a Docker Start/Init Script?</h2>

<p>A Docker start/init script is simply a script which is executed when the container starts.</p>

<p>The script can be called manually while one runs a container:</p>

<pre><code>docker run -it user_name/image_name /usr/lib/init-script-name.sh
</code></pre>

<p>Or through one of the <code>Dockerfile</code> directives:
- <a href="http://docs.docker.com/reference/builder/#entrypoint"><code>ENTRYPOINT</code></a>
- <a href="http://docs.docker.com/reference/builder/#cmd"><code>CMD</code></a></p>

<h2 id="resources">Resources:</h2>

<ul>
  <li><a href="http://developerblog.redhat.com/2014/09/30/overview-storage-scalability-docker/">Comprehensive Overview of Storage Scalability in Docker</a></li>
  <li><a href="https://registry.hub.docker.com/_/mysql/">MySQL Docker image <code>README.md</code></a></li>
  <li><a href="http://bitjudo.com/blog/2014/03/13/building-efficient-dockerfiles-node-dot-js/">Building Efficient Dockerfiles for Node.js Applications</a></li>
  <li><a href="https://docs.docker.com/userguide/dockervolumes/">Managing Data in Containers</a></li>
  <li><a href="https://docs.docker.com/articles/networking/#container-networking">Docker Networking</a></li>
</ul>

              </article>

              <div class="article__author-container">
    <div class="divider  divider--text">
        <p class="typography-small">Author</p>
    </div>

    <img class="article__avatar" src="http://www.gravatar.com/avatar/88954c51cd72a270af461de17fa2e150.png" alt="czerasz avatar" height="80" width="80">

    <div class="article__author-info">
        <h4>Michał Czeraszkiewicz</h4>
        <p>Full Stack Developer, Consultant. Web technology enthusiast with pashion for web architecture. You can follow him on <a href="https://twitter.com/czerasz" target="_blank">Twitter</a>  or <a href="" target="_blank">Google+</a>.</p>
    </div> <!-- gem-author-info --> 
</div>

              <div class="divider  clearfix"></div>

              <div class="post__navigation-bottom">
                <a class="btn  btn-default" href="/blog">
                  <span class="glyphicon glyphicon-chevron-left"></span>
                  back
                </a>
                <a class="btn  btn-primary" href="#home">
                  <span class="glyphicon glyphicon-chevron-up"></span>
                  go up
                </a>
              </div>

              <div class="divider  clearfix"></div>              

              <section class="callout  callout--center">
    <h3>Like what You see?</h3>

    <a class="btn  btn-lg  btn-primary" href="/contact">Then let us work together!</a>

    <p>We provide high quality web IT services. From solid front-end architecture, through scalable back-end applications, up to distrubuted data stores. Every piece of your infrastructure is build with passion.</p>
</section>
        </div>
    </div>
</div>

    <footer class="site-footer">
  <div class="site-footer__footer-above">
    <div class="container">
      <div class="row">
      

        <div class="col-md-4  col-md-offset-4">
          <h3>Social</h3>

          <div class="footer__social-icons">
            <a href="https://twitter.com/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's twitter page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-twitter"></use>
              </svg>
            </a>
            <a href="https://github.com/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's github profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-github"></use>
              </svg>
            </a>
            <a href="http://stackoverflow.com/users/325852/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's stackoverflow profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-stackoverflow"></use>
              </svg>
            </a>
            <a href="https://www.linkedin.com/in/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's linkedin profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-linkedin"></use>
              </svg>
            </a>
            <a href="https://delicious.com/czerasz">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's delicious profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-delicious"></use>
              </svg>
            </a>
            <a href="#">
              <svg viewBox="0 0 30 30" class="svg-icon" alt="czerasz's google plus profile page">
                <use xlink:href="/assets/1419845847752/img/svg/social.svg#icon-google-plus"></use>
              </svg>
            </a>
          </div>

          <div class="divider  divider--border  visible-xs-block  visible-sm-block"></div>
        </div>
        <div class="col-md-4">
          <h3>About</h3>
          <p>Solid knowledge about web and web-technologies. Focused on Back-End, Front-End and DevOps topics. Docker, Python, Nginx, Linux, IT-Architecture, Vagrant, Ansible, MongoDB and Elasticsearch.
</p>
          <a class="btn  btn-default  pull-right" style="margin-top: 20px" href="/about/">read more</a>
        </div>
      </div>
    </div>
  </div>

  <div class="site-footer__footer-below">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <p class="text-center">© 2015 &middot; czerasz &middot; All Rights Reserved
          
          |
          Made with &hearts; in Berlin</p>
        </div>
      </div>
    </div>
  </div>
</footer>

    
    <script src="/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    


    


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18008380-5', 'auto');
  ga('send', 'pageview');
</script>
  </body>

</html>